# 财务模块测试指南

## 前提条件

在测试财务模块之前，请确保：

1. ✅ MySQL 8.0+ 已安装并运行
2. ✅ 已创建数据库 `barbershop_mis`
3. ✅ 已配置 `application.properties` 中的数据库连接信息
4. ✅ 已启动应用程序（`mvn spring-boot:run`）
5. ✅ 已登录系统（使用管理员账号）

## 测试场景

### 场景一：服务收入功能测试

#### 1. 准备测试数据

在测试服务收入之前，需要先有服务执行记录。可以通过以下方式创建：

1. 在"会员管理"中添加测试会员
2. 在"员工管理"中添加测试员工
3. 在"服务项目管理"中添加测试服务
4. 在"服务执行管理"中手动添加几条执行记录

或者通过预约流程：
1. 创建预约
2. 将预约状态更改为"已服务"（会自动创建服务执行记录）

#### 2. 访问财务管理模块

1. 点击左侧菜单的"💰 财务管理"
2. 应该看到两个子模块：
   - 📈 服务收入
   - 📉 采购支出

#### 3. 测试服务收入列表

**预期结果：**
- ✅ 显示所有服务执行记录
- ✅ 包含字段：服务记录ID、会员ID、项目ID、员工ID、费用、日期
- ✅ 底部显示"总收入"统计
- ✅ 总收入金额正确（所有记录的费用总和）

#### 4. 测试筛选功能

测试以下筛选条件：

**按会员筛选：**
1. 选择特定会员
2. 点击"🔍 查询"
3. ✅ 应该只显示该会员的服务记录
4. ✅ 总收入应该只统计该会员的记录

**按服务项目筛选：**
1. 选择特定服务项目
2. 点击"🔍 查询"
3. ✅ 应该只显示该服务项目的记录
4. ✅ 总收入应该只统计该服务项目的记录

**按员工筛选：**
1. 选择特定员工
2. 点击"🔍 查询"
3. ✅ 应该只显示该员工服务的记录
4. ✅ 总收入应该只统计该员工的记录

**按日期筛选：**
1. 选择特定日期
2. 点击"🔍 查询"
3. ✅ 应该只显示该日期的记录
4. ✅ 总收入应该只统计该日期的记录

**组合筛选：**
1. 同时选择多个筛选条件
2. 点击"🔍 查询"
3. ✅ 应该显示满足所有条件的记录
4. ✅ 总收入应该正确统计

**重置筛选：**
1. 点击"🔄 重置"按钮
2. ✅ 所有筛选条件应该清空
3. ✅ 显示所有记录
4. ✅ 总收入显示所有记录的总和

#### 5. 验证统计准确性

**重要：** 总收入应该是当前筛选条件下**所有记录**的总和，而不仅仅是当前页显示的记录。

### 场景二：采购支出功能测试

#### 1. 准备测试数据

在测试采购功能之前，需要先有库存物品：

1. 在"库存管理"中添加几个测试物品
2. 记录当前库存数量

#### 2. 测试新增采购记录

1. 在"采购支出"部分点击"+ 新增采购记录"
2. 填写采购信息：
   - 选择物品
   - 输入数量（例如：10）
   - 输入单价（例如：15.50）
3. 点击"保存"

**预期结果：**
- ✅ 显示"采购成功！库存已更新"消息
- ✅ 采购记录列表中显示新记录
- ✅ 记录包含：采购记录ID、物品ID、物品名称、数量、单价、总价、日期
- ✅ 总价 = 数量 × 单价（例如：10 × 15.50 = 155.00）
- ✅ 底部"总支出"增加对应金额

#### 3. 验证库存更新

1. 切换到"库存管理"模块
2. 查找刚才采购的物品

**预期结果：**
- ✅ 物品库存数量 = 原库存 + 采购数量
- ✅ 如果原来库存不足，备注状态应该更新为"库存充足"

#### 4. 测试采购筛选功能

**按物品筛选：**
1. 在采购支出部分，选择特定物品
2. 点击"🔍 查询"
3. ✅ 应该只显示该物品的采购记录
4. ✅ 总支出应该只统计该物品的记录

**按日期筛选：**
1. 选择特定日期
2. 点击"🔍 查询"
3. ✅ 应该只显示该日期的采购记录
4. ✅ 总支出应该只统计该日期的记录

**组合筛选：**
1. 同时选择物品和日期
2. 点击"🔍 查询"
3. ✅ 应该显示满足所有条件的记录
4. ✅ 总支出应该正确统计

**重置筛选：**
1. 点击"🔄 重置"按钮
2. ✅ 所有筛选条件应该清空
3. ✅ 显示所有采购记录
4. ✅ 总支出显示所有记录的总和

#### 5. 测试删除采购记录

1. 点击某条采购记录的"删除"按钮
2. 确认删除

**预期结果：**
- ✅ 记录从列表中移除
- ✅ 总支出相应减少
- ⚠️ **注意**：库存不会回退（这是设计行为）

#### 6. 测试数据验证

**测试无效输入：**

1. 尝试不选择物品就提交
   - ✅ 应该显示"请选择物品"错误消息

2. 尝试输入数量为0或负数
   - ✅ 应该显示"采购数量必须大于0"错误消息

3. 尝试输入单价为0或负数
   - ✅ 应该显示"单价必须大于0"错误消息

### 场景三：验证库存管理模块变更

#### 1. 确认采购按钮已移除

1. 切换到"📦 库存管理"模块
2. 查看库存物品列表

**预期结果：**
- ✅ 每个物品的操作栏应该只有"修改"和"删除"按钮
- ✅ 不应该再有"采购"按钮
- ✅ 不应该再有采购弹窗

#### 2. 确认只能通过财务模块采购

1. 尝试在库存管理中寻找任何采购入口
2. ✅ 应该找不到任何采购相关功能
3. 切换到财务管理模块
4. ✅ 采购功能应该只在"采购支出"部分可用

### 场景四：事务一致性测试

#### 1. 测试并发采购

如果可能，尝试快速连续提交多个采购记录：

1. 为同一物品创建多个采购记录
2. ✅ 所有采购都应该成功
3. ✅ 库存应该正确累加
4. ✅ 采购记录应该全部保存

#### 2. 测试异常情况

1. 在数据库中手动删除某个物品
2. 尝试为该物品创建采购记录
3. ✅ 应该显示"库存物品不存在"错误消息
4. ✅ 不应该创建采购记录

## 性能测试

### 测试大数据量统计

1. 创建100+条服务执行记录
2. 创建50+条采购记录
3. 测试筛选和统计功能

**预期结果：**
- ✅ 筛选响应时间应该在1秒内
- ✅ 统计数据准确无误
- ✅ 页面不应该卡顿或崩溃

## API测试（可选）

### 使用curl或Postman测试API

#### 1. 测试服务收入API

```bash
# 获取所有服务收入
curl http://localhost:8080/api/financial/income

# 按条件筛选
curl "http://localhost:8080/api/financial/income?memberId=1&serviceDate=2026-01-08"
```

**预期响应：**
```json
{
  "records": [...],
  "totalIncome": 1500.00
}
```

#### 2. 测试采购记录API

```bash
# 获取所有采购记录
curl http://localhost:8080/api/financial/purchase

# 新增采购记录
curl -X POST http://localhost:8080/api/financial/purchase \
  -H "Content-Type: application/json" \
  -d '{
    "inventoryId": 1,
    "quantity": 10,
    "unitPrice": 15.50
  }'

# 按条件筛选
curl "http://localhost:8080/api/financial/purchase?inventoryId=1"
```

**预期响应：**
```json
{
  "records": [...],
  "totalExpenditure": 500.00
}
```

## 常见问题排查

### 问题1：总收入/总支出显示为0

**可能原因：**
- 数据库中没有数据
- 筛选条件过于严格，没有匹配的记录

**解决方案：**
- 创建测试数据
- 重置筛选条件

### 问题2：采购后库存没有更新

**可能原因：**
- 事务未提交
- 数据库连接问题

**解决方案：**
- 刷新页面
- 检查控制台错误日志
- 检查数据库连接

### 问题3：无法访问财务管理模块

**可能原因：**
- JavaScript文件加载失败
- 浏览器缓存问题

**解决方案：**
- 清除浏览器缓存
- 强制刷新页面（Ctrl+F5）
- 检查浏览器控制台错误

## 测试通过标准

所有以下测试项目都应该通过：

- ✅ 服务收入能正确显示所有执行记录
- ✅ 服务收入筛选功能工作正常
- ✅ 服务收入总计算准确（全量统计）
- ✅ 采购记录能成功创建
- ✅ 采购后库存自动更新
- ✅ 采购支出筛选功能工作正常
- ✅ 采购支出总计算准确（全量统计）
- ✅ 库存管理模块不再有采购功能
- ✅ 采购数据验证正常
- ✅ 删除采购记录功能正常
- ✅ 无明显的性能问题

## 测试完成

如果所有测试都通过，说明财务模块实现正确，可以投入使用。

如果发现任何问题，请记录以下信息：
1. 问题描述
2. 复现步骤
3. 预期结果
4. 实际结果
5. 浏览器控制台错误（如有）
6. 服务器日志错误（如有）
