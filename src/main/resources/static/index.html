<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç†å‘åº—ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
  * {
      box-sizing: border-box;
  }

  body {
      margin: 0;
      font-family:  'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      height: 100vh;
      background: #f4f6f8;
      color: #333;
      font-size: 15px;
      overflow: hidden;
  }

  /* å·¦ä¾§è¾¹æ  */
  .sidebar {
      width: 220px;
      min-width: 220px;
      background: linear-gradient(180deg, #ffffff 0%, #f2f2f2 100%);
      color: #000;
      display: flex;
      flex-direction: column;
      border-radius: 0 15px 15px 0;
      box-shadow: 2px 0 10px rgba(255, 255, 255, 0.6);
      height: 100vh;
      overflow-y: auto;
  }

  .sidebar h2 {
      text-align: center;
      padding: 20px 0;
      border-bottom: 1px solid #34495e;
      margin: 0;
      font-size: 18px;
      border-radius: 0 15px 0 0;
  }

  .menu-item {
      padding: 15px 20px;
      cursor:  pointer;
      border-bottom:  1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
      margin:  2px 8px;
      border-radius: 8px;
      font-size: 14px;
  }

  .menu-item:hover, .menu-item.active {
      background: rgba(52, 152, 219, 0.2);
      border-left: 4px solid #3498db;
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
  }

  .user-info {
  margin-top: auto;
  padding: 20px;
  font-size: 13px;
  background: #fff;
  color: #000;
  border-radius: 0 0 15px 0;
  border-top: 1px solid rgba(0,0,0,0.1);
}

  .logout {
      color: #e74c3c;
      cursor: pointer;
      text-decoration: underline;
      margin-left: 10px;
      transition: color 0.3s;
  }

  .logout:hover {
      color: #c0392b;
  }

  /* å³ä¾§ä¸»å†…å®¹åŒº - å æ®å‰©ä½™ç©ºé—´ */
  .main-content {
      flex: 1;
      display:  flex;
      flex-direction:  column;
      padding: 25px;
      overflow: hidden;
      height: 100vh;
  }

  /* é¡¶éƒ¨æ  */
  .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      font-size: 17px;
      flex-shrink:  0;
  }

  .calendar-box {
      font-weight: bold;
      color: #555;
      font-size:  16px;
  }

  /* æ¨¡å—åŒºåŸŸ - å æ®å‰©ä½™ç©ºé—´ */
  .module-section {
      display: none;
      background: white;
      padding: 35px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      flex: 1;
      overflow-y: auto;
  }

  .module-section.active {
      display: block;
  }

  . module-section h3 {
      font-size: 24px;
      margin-bottom: 22px;
      margin-top: 0;
      color:  #2c3e50;
      font-weight: 600;
  }

  /* æœç´¢æ¡† */
  .search-box {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 22px;
      border: 1px solid #eee;
  }

  /* è¡¨æ ¼ */
  table {
      width:  100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 16px;
  }

  th, td {
      border: 1px solid #eee;
      padding: 16px 14px;
      text-align: left;
  }

  th {
      background: #f8f9fa;
      color: #555;
      font-weight: 600;
      font-size: 16px;
  }

  td {
      font-size: 15px;
  }

  /* è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡† */
  input, select {
      padding: 11px 15px;
      border: 1px solid #ddd;
      margin-right: 8px;
      border-radius: 6px;
      transition: border-color 0.3s;
      font-size: 15px;
      min-height:  40px;
  }

  input:focus, select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
  }

  /* æŒ‰é’® */
  button {
      padding: 11px 20px;
      border:  none;
      border-radius:  6px;
      color:  white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      font-size: 15px;
      min-height: 40px;
      margin-right: 6px;
  }

  button: hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .btn-add {
      background: #28a745;
  }

  .btn-add:hover {
      background: #218838;
  }

  .btn-del {
      background: #dc3545;
  }

  .btn-del:hover {
      background:  #c82333;
  }

  .btn-edit {
      background: #ffc107;
      color: #333;
  }

  .btn-edit:hover {
      background: #e0a800;
  }

  .btn-search {
      background: #17a2b8;
  }

  . btn-search:hover {
      background: #138496;
  }

  .btn-recharge {
      background: #17a2b8;
  }

  .btn-recharge:hover {
      background: #138496;
  }

  .btn-cancel {
      background: #6c757d;
  }

  .btn-cancel:hover {
      background: #5a6268;
  }

  /* å¼¹çª— */
  .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(3px);
  }

  .modal-content {
      background-color:  #fff;
      margin: 8% auto;
      padding:  25px;
      border-radius: 12px;
      width: 450px;
      max-width: 90%;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
      from {
          opacity: 0;
          transform: translateY(-50px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }

  .modal-header {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      border-bottom:  2px solid #eee;
      padding-bottom: 12px;
      color: #2c3e50;
  }

  .form-group {
      margin-bottom: 18px;
  }

  .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 15px;
      color: #555;
  }

  .form-group input, .form-group select {
      width: 95%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
  }

  .form-group small {
      font-size: 13px;
      color: #666;
  }

  .modal-footer {
      text-align: right;
      margin-top: 25px;
  }

  /* æœåŠ¡å¼¹çª—ç‰¹æ®Šæ ·å¼ */
  #serviceModal .modal-content {
      width: 550px;
      max-width:  90%;
  }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>ğŸ’ˆ æ‚¦å®¹ç†å‘åº—</h2>
    <div class="menu-item active" data-tab="member">ğŸ‘¤ ä¼šå‘˜ç®¡ç†</div>
    <div class="menu-item" data-tab="employee">ğŸ‘” å‘˜å·¥ç®¡ç†</div>
    <div class="menu-item" data-tab="admin">ğŸ›¡ï¸ ç®¡ç†å‘˜ç®¡ç†</div>
    <div class="menu-item" data-tab="inventory">ğŸ“¦ åº“å­˜ç®¡ç†</div>
    <div class="menu-item" data-tab="service">ğŸ’‡ æœåŠ¡é¡¹ç›®ç®¡ç†</div>
    <div class="menu-item" data-tab="appointment">ğŸ“… é¢„çº¦ç®¡ç†</div>
    <div class="menu-item" data-tab="execution">âœ… æœåŠ¡æ‰§è¡Œç®¡ç†</div>
    <div class="menu-item" data-tab="financial">ğŸ’° è´¢åŠ¡ç®¡ç†</div>
    <div class="user-info">
        å½“å‰ç”¨æˆ·ï¼š<span id="currentAdminName">... </span>
        <span class="logout" onclick="logout()">é€€å‡º</span>
    </div>
</div>

<div class="main-content">
    <div class="top-bar">
        <div>æ¬¢è¿ä½¿ç”¨ç®¡ç†ç³»ç»Ÿ</div>
        <div class="calendar-box">ğŸ“… å½“å‰æ—¶é—´ï¼š<span id="clock"></span></div>
    </div>

    <!-- 1. ä¼šå‘˜ -->
    <div id="member-section" class="module-section active">
        <h3>ğŸ‘¤ ä¼šå‘˜ç®¡ç†</h3>
        <div class="search-box">
            <input type="text" id="searchMemberInput" placeholder="è¾“å…¥æ‰‹æœºå·æŸ¥è¯¢..." style="width: 200px;">
            <button class="btn-search" onclick="searchMember()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="resetMemberSearch()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <input type="text" id="mName" placeholder="å§“å">
            <input type="text" id="mPhone" placeholder="æ‰‹æœºå·">
            <select id="mGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <button class="btn-add" onclick="addMember()">+ æ–°å¢ä¼šå‘˜</button>
        </div>
        <table id="memberTable">
            <thead><tr><th>ID</th><th>å§“å</th><th>æ‰‹æœº</th><th>æ€§åˆ«</th><th>ä½™é¢</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 2. å‘˜å·¥ -->
    <div id="employee-section" class="module-section">
        <h3>ğŸ‘” å‘˜å·¥ç®¡ç†</h3>
        <div class="search-box">
            <input type="text" id="searchEmpInput" placeholder="è¾“å…¥å·¥å·æˆ–æ‰‹æœºå·æŸ¥è¯¢" style="width: 200px;">
            <button class="btn-search" onclick="searchEmployee()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="resetEmployeeSearch()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <input type="text" id="eName" placeholder="å‘˜å·¥å§“å">
            <input type="text" id="ePhone" placeholder="å‘˜å·¥æ‰‹æœº">
            <select id="eGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <button class="btn-add" onclick="addEmployee()">+ æ–°å¢å‘˜å·¥</button>
        </div>
        <table id="employeeTable">
            <thead><tr><th>å·¥å· (ID)</th><th>å§“å</th><th>æ‰‹æœºå·</th><th>æ€§åˆ«</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 3. ç®¡ç†å‘˜ -->
    <div id="admin-section" class="module-section">
        <h3>ğŸ›¡ï¸ ç®¡ç†å‘˜æ¡£æ¡ˆ</h3>
        <div style="margin-bottom: 15px;">
            <input type="text" id="aName" placeholder="ç®¡ç†å‘˜å§“å">
            <input type="text" id="aPhone" placeholder="ç™»å½•æ‰‹æœºå·">
            <select id="aGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <button class="btn-add" onclick="addAdmin()">+ æ–°å¢ç®¡ç†å‘˜</button>
        </div>
        <table id="adminTable">
            <thead><tr><th>ID</th><th>å§“å</th><th>ç™»å½•æ‰‹æœº</th><th>æ€§åˆ«</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 4. åº“å­˜ -->
    <div id="inventory-section" class="module-section">
        <h3>ğŸ“¦ åº“å­˜ç®¡ç†</h3>
        <div class="search-box">
            <input type="text" id="searchInv" placeholder="è¾“å…¥ç‰©å“åç§°æˆ–IDæŸ¥è¯¢" style="width: 200px;">
            <button class="btn-search" onclick="searchInventory()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="loadInventory()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <input type="text" id="iName" placeholder="ç‰©å“åç§°">
            <input type="number" id="iQty" placeholder="åˆå§‹åº“å­˜" min="0" style="width: 100px;">
            <input type="number" id="iThreshold" placeholder="è­¦æˆ’çº¿" min="0" style="width: 100px;">
            <button class="btn-add" onclick="addInventory()">+ æ–°å¢ç‰©å“</button>
        </div>
        <table id="inventoryTable">
            <thead><tr><th>ID</th><th>ç‰©å“åç§°</th><th>å½“å‰åº“å­˜</th><th>è­¦æˆ’çº¿</th><th>å¤‡æ³¨çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 5. æœåŠ¡ -->
    <div id="service-section" class="module-section">
        <h3>ğŸ’‡ æœåŠ¡é¡¹ç›®ç®¡ç†</h3>
        <div class="search-box">
            <input type="text" id="searchServiceInput" placeholder="è¾“å…¥æœåŠ¡åç§°æˆ–ID" style="width: 200px;">
            <button class="btn-search" onclick="searchService()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="loadServices()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <button class="btn-add" onclick="openAddServiceModal()">+ æ–°å¢æœåŠ¡é¡¹ç›®</button>
        </div>
        <table id="serviceTable">
            <thead><tr><th>ID</th><th>æœåŠ¡åç§°</th><th>ä»·æ ¼</th><th>ç”¨æ—¶(åˆ†é’Ÿ)</th><th>æ¶ˆè€—ç‰©å“IDs</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 6. é¢„çº¦ç®¡ç† -->
    <div id="appointment-section" class="module-section">
        <h3>ğŸ“… é¢„çº¦ç®¡ç†</h3>
        <div class="search-box">
            <input type="text" id="searchAppInput" placeholder="ID/ä¼šå‘˜/å‘˜å·¥ æˆ– 2026-01-01" style="width: 250px;">
            <button class="btn-search" onclick="searchApp()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="loadApps()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <button class="btn-add" onclick="openAddAppModal()">+ æ–°å¢é¢„çº¦</button>
        </div>
        <table id="appTable">
            <thead><tr><th>ID</th><th>æ—¥æœŸ</th><th>æ—¶é—´æ®µ</th><th>ä¼šå‘˜</th><th>æœåŠ¡é¡¹ç›®</th><th>å‘˜å·¥</th><th>å¤‡æ³¨</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 7. æœåŠ¡æ‰§è¡Œç®¡ç† -->
    <div id="execution-section" class="module-section">
        <h3>âœ… æœåŠ¡æ‰§è¡Œç®¡ç†</h3>
        <div class="search-box">
            <label style="margin-right: 10px;">ç­›é€‰æ¡ä»¶ï¼š</label>
            <select id="filterMemberId" style="width: 150px;">
                <option value="">å…¨éƒ¨ä¼šå‘˜</option>
            </select>
            <select id="filterServiceId" style="width: 150px;">
                <option value="">å…¨éƒ¨æœåŠ¡</option>
            </select>
            <select id="filterEmployeeId" style="width: 150px;">
                <option value="">å…¨éƒ¨å‘˜å·¥</option>
            </select>
            <input type="date" id="filterServiceDate" style="width: 150px;">
            <button class="btn-search" onclick="searchExecution()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="resetExecutionSearch()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <button class="btn-add" onclick="openAddExecutionModal()">+ æ–°å¢æœåŠ¡æ‰§è¡Œè®°å½•</button>
        </div>
        <table id="executionTable">
            <thead><tr><th>ID</th><th>ä¼šå‘˜ID</th><th>ä¼šå‘˜å§“å</th><th>æœåŠ¡é¡¹ç›®ID</th><th>æœåŠ¡é¡¹ç›®åç§°</th><th>å‘˜å·¥ID</th><th>å‘˜å·¥å§“å</th><th>è´¹ç”¨</th><th>æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 8. è´¢åŠ¡ç®¡ç† -->
    <div id="financial-section" class="module-section">
        <h3>ğŸ’° è´¢åŠ¡ç®¡ç†</h3>
        
        <!-- 8.1 æœåŠ¡æ”¶å…¥ -->
        <div style="margin-top: 20px;">
            <h4 style="color: #27ae60; border-left: 4px solid #27ae60; padding-left: 10px;">ğŸ“ˆ æœåŠ¡æ”¶å…¥</h4>
            <div class="search-box">
                <label style="margin-right: 10px;">ç­›é€‰æ¡ä»¶ï¼š</label>
                <select id="incomeFilterMemberId" style="width: 150px;">
                    <option value="">å…¨éƒ¨ä¼šå‘˜</option>
                </select>
                <select id="incomeFilterServiceId" style="width: 150px;">
                    <option value="">å…¨éƒ¨æœåŠ¡</option>
                </select>
                <select id="incomeFilterEmployeeId" style="width: 150px;">
                    <option value="">å…¨éƒ¨å‘˜å·¥</option>
                </select>
                <input type="date" id="incomeFilterDate" style="width: 150px;">
                <button class="btn-search" onclick="searchIncome()">ğŸ” æŸ¥è¯¢</button>
                <button class="btn-cancel" onclick="resetIncomeSearch()">ğŸ”„ é‡ç½®</button>
            </div>
            <table id="incomeTable">
                <thead><tr><th>æœåŠ¡è®°å½•ID</th><th>ä¼šå‘˜ID</th><th>é¡¹ç›®ID</th><th>å‘˜å·¥ID</th><th>è´¹ç”¨</th><th>æ—¥æœŸ</th></tr></thead>
                <tbody></tbody>
                <tfoot>
                    <tr style="background: #d5f4e6; font-weight: bold;">
                        <td colspan="4" style="text-align: right; padding-right: 20px;">æ€»æ”¶å…¥ï¼š</td>
                        <td id="totalIncome" style="color: #27ae60; font-size: 16px;">Â¥0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- 8.2 é‡‡è´­æ”¯å‡º -->
        <div style="margin-top: 30px;">
            <h4 style="color: #e74c3c; border-left: 4px solid #e74c3c; padding-left: 10px;">ğŸ“‰ é‡‡è´­æ”¯å‡º</h4>
            <div class="search-box">
                <label style="margin-right: 10px;">ç­›é€‰æ¡ä»¶ï¼š</label>
                <select id="purchaseFilterInventoryId" style="width: 150px;">
                    <option value="">å…¨éƒ¨ç‰©å“</option>
                </select>
                <input type="date" id="purchaseFilterDate" style="width: 150px;">
                <button class="btn-search" onclick="searchPurchase()">ğŸ” æŸ¥è¯¢</button>
                <button class="btn-cancel" onclick="resetPurchaseSearch()">ğŸ”„ é‡ç½®</button>
            </div>
            <div style="margin-bottom: 15px;">
                <button class="btn-add" onclick="openAddPurchaseModal()">+ æ–°å¢é‡‡è´­è®°å½•</button>
            </div>
            <table id="purchaseTable">
                <thead><tr><th>é‡‡è´­è®°å½•ID</th><th>ç‰©å“ID</th><th>ç‰©å“åç§°</th><th>æ•°é‡</th><th>å•ä»·</th><th>æ€»ä»·</th><th>æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead>
                <tbody></tbody>
                <tfoot>
                    <tr style="background: #fadbd8; font-weight: bold;">
                        <td colspan="5" style="text-align: right; padding-right: 20px;">æ€»æ”¯å‡ºï¼š</td>
                        <td id="totalExpenditure" style="color: #e74c3c; font-size: 16px;">Â¥0.00</td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- ================== å¼¹çª—ç»„ä»¶åŒº ================== -->

<!-- 1. ä¼šå‘˜ä¿®æ”¹ -->
<div id="editMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">âœï¸ ä¿®æ”¹ä¼šå‘˜ä¿¡æ¯</div>
        <input type="hidden" id="editMemId">
        <div class="form-group"><label>å§“å</label><input type="text" id="editMemName"></div>
        <div class="form-group"><label>æ‰‹æœºå·</label><input type="text" id="editMemPhone"></div>
        <div class="form-group"><label>æ€§åˆ«</label><select id="editMemGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('editMemberModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitEditMember()">ä¿å­˜</button></div>
    </div>
</div>

<!-- ä¼šå‘˜ä½™é¢å……å€¼ -->
<div id="rechargeMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">ğŸ’° ä¼šå‘˜ä½™é¢å……å€¼</div>
        <input type="hidden" id="rechargeMemId">
        <div class="form-group">
            <label>ä¼šå‘˜å§“å</label>
            <input type="text" id="rechargeMemName" readonly style="background:#f0f0f0">
        </div>
        <div class="form-group">
            <label>å½“å‰ä½™é¢</label>
            <input type="text" id="rechargeMemBalance" readonly style="background:#f0f0f0">
        </div>
        <div class="form-group">
            <label>å……å€¼é‡‘é¢ <span style="color:red">*</span></label>
            <input type="number" id="rechargeAmount" placeholder="è¯·è¾“å…¥å……å€¼é‡‘é¢" min="0.01" step="0.01">
            <small style="color:#666">å……å€¼é‡‘é¢å¿…é¡»å¤§äº0</small>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('rechargeMemberModal')">å–æ¶ˆ</button>
            <button class="btn-add" onclick="submitRecharge()">ç¡®è®¤å……å€¼</button>
        </div>
    </div>
</div>

<!-- 2. å‘˜å·¥ä¿®æ”¹ -->
<div id="editEmpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">âœï¸ ä¿®æ”¹å‘˜å·¥ä¿¡æ¯</div>
        <input type="hidden" id="editEmpId">
        <div class="form-group"><label>å§“å</label><input type="text" id="editEmpName"></div>
        <div class="form-group"><label>æ‰‹æœºå·</label><input type="text" id="editEmpPhone"></div>
        <div class="form-group"><label>æ€§åˆ«</label><select id="editEmpGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('editEmpModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitEditEmployee()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 3. ç®¡ç†å‘˜ä¿®æ”¹ -->
<div id="editAdminModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">âœï¸ ä¿®æ”¹ç®¡ç†å‘˜ä¿¡æ¯</div>
        <input type="hidden" id="editAdminId">
        <div class="form-group"><label>å§“å</label><input type="text" id="editAdminName"></div>
        <div class="form-group"><label>æ‰‹æœºå·</label><input type="text" id="editAdminPhone"></div>
        <div class="form-group"><label>æ€§åˆ«</label><select id="editAdminGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('editAdminModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitEditAdmin()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 4.1 åº“å­˜ä¿®æ”¹ -->
<div id="editInvModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">âœï¸ ä¿®æ”¹ç‰©å“ä¿¡æ¯</div>
        <input type="hidden" id="eiId">
        <div class="form-group"><label>ç‰©å“åç§°</label><input type="text" id="eiName"></div>
        <div class="form-group"><label>åº“å­˜æ•°é‡</label><input type="number" id="eiQty"></div>
        <div class="form-group"><label>è­¦æˆ’çº¿</label><input type="number" id="eiThreshold"></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('editInvModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitEditInv()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 5. æœåŠ¡ä¿®æ”¹/æ–°å¢ -->
<div id="serviceModal" class="modal">
    <div class="modal-content" style="width: 550px;">
        <div class="modal-header" id="serviceModalTitle">æ–°å¢æœåŠ¡</div>
        <input type="hidden" id="svcId">
        <div class="form-group"><label>æœåŠ¡åç§°</label><input type="text" id="svcName"></div>
        <div class="form-group"><label>ä»·æ ¼ (å…ƒ)</label><input type="number" id="svcPrice"></div>
        <div class="form-group">
            <label>æœåŠ¡ç”¨æ—¶ (åˆ†é’Ÿ)</label>
            <select id="svcDuration">
                <option value="60">60 åˆ†é’Ÿ (1å°æ—¶)</option>
                <option value="120">120 åˆ†é’Ÿ (2å°æ—¶)</option>
                <option value="180">180 åˆ†é’Ÿ (3å°æ—¶)</option>
            </select>
        </div>
        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
        <label style="font-weight: bold; display: block; margin-bottom: 10px;">æ¶ˆè€—ç‰©å“ (æœ€å¤šé€‰5ä¸ª)</label>
        <div class="form-group"><select id="svcItem1" class="item-select"><option value="">-- æ— æ¶ˆè€— --</option></select></div>
        <div class="form-group"><select id="svcItem2" class="item-select"><option value="">-- æ— æ¶ˆè€— --</option></select></div>
        <div class="form-group"><select id="svcItem3" class="item-select"><option value="">-- æ— æ¶ˆè€— --</option></select></div>
        <div class="form-group"><select id="svcItem4" class="item-select"><option value="">-- æ— æ¶ˆè€— --</option></select></div>
        <div class="form-group"><select id="svcItem5" class="item-select"><option value="">-- æ— æ¶ˆè€— --</option></select></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('serviceModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitService()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 6. æ–°å¢é¢„çº¦å¼¹çª— -->
<div id="addAppModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">ğŸ“… æ–°å¢é¢„çº¦</div>
        <div class="form-group"><label>é€‰æ‹©æ—¥æœŸ</label><input type="date" id="appDate"></div>
        <div class="form-group">
            <label>å¼€å§‹æ—¶é—´ (æ•´ç‚¹)</label>
            <select id="appStartHour">
                <option value="" disabled selected>-- è¯·é€‰æ‹© --</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
            </select>
            <small style="color:#666">æ³¨:  12:00-14:00 ä¸ºåˆä¼‘</small>
        </div>
        <div class="form-group"><label>é€‰æ‹©ä¼šå‘˜</label><select id="appMemberId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="form-group"><label>é€‰æ‹©æœåŠ¡</label><select id="appServiceId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="form-group"><label>é€‰æ‹©å‘˜å·¥</label><select id="appEmployeeId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('addAppModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitApp()">æäº¤é¢„çº¦</button></div>
    </div>
</div>

<!-- 7. æ–°å¢æœåŠ¡æ‰§è¡Œè®°å½•å¼¹çª— -->
<div id="addExecutionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">âœ… æ–°å¢æœåŠ¡æ‰§è¡Œè®°å½•</div>
        <div class="form-group"><label>é€‰æ‹©ä¼šå‘˜</label><select id="execMemberId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="form-group"><label>é€‰æ‹©æœåŠ¡é¡¹ç›®</label><select id="execServiceId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="form-group"><label>é€‰æ‹©å‘˜å·¥</label><select id="execEmployeeId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="form-group"><label>æœåŠ¡æ—¥æœŸ</label><input type="date" id="execServiceDate"></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('addExecutionModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitExecution()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 8. ä¿®æ”¹æœåŠ¡æ‰§è¡Œè®°å½•å¼¹çª— -->
<div id="editExecutionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">âœï¸ ä¿®æ”¹æœåŠ¡æ‰§è¡Œè®°å½•</div>
        <input type="hidden" id="editExecId">
        <div class="form-group"><label>é€‰æ‹©ä¼šå‘˜</label><select id="editExecMemberId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="form-group"><label>é€‰æ‹©æœåŠ¡é¡¹ç›®</label><select id="editExecServiceId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="form-group"><label>é€‰æ‹©å‘˜å·¥</label><select id="editExecEmployeeId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="form-group"><label>æœåŠ¡æ—¥æœŸ</label><input type="date" id="editExecServiceDate"></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('editExecutionModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitEditExecution()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 9. æ–°å¢é‡‡è´­è®°å½•å¼¹çª— -->
<div id="addPurchaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">ğŸ›’ æ–°å¢é‡‡è´­è®°å½•</div>
        <div class="form-group">
            <label>é€‰æ‹©ç‰©å“</label>
            <select id="purchaseInventoryId">
                <option value="">è¯·é€‰æ‹©ç‰©å“...</option>
            </select>
        </div>
        <div class="form-group"><label>é‡‡è´­æ•°é‡</label><input type="number" id="purchaseQuantity" placeholder="è¾“å…¥æ•°é‡ï¼ˆå¿…é¡»å¤§äº0ï¼‰" min="1"></div>
        <div class="form-group"><label>å•ä»·ï¼ˆå…ƒï¼‰</label><input type="number" id="purchaseUnitPrice" placeholder="è¾“å…¥å•ä»·ï¼ˆå¿…é¡»å¤§äº0ï¼‰" step="0.01" min="0.01"></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('addPurchaseModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitPurchase()">ä¿å­˜</button></div>
    </div>
</div>

<script>
    let currentAdmin = null;
    const PHONE_REGEX = /^1[3-9]\d{9}$/;
    let inventoryCache = [];

    window.onload = function() {
        const str = localStorage.getItem('currentAdmin');
        if (!str) {
            window.location.href = '/login.html';
            return;
        }
        try {
            currentAdmin = JSON. parse(str);
            document.getElementById('currentAdminName').innerText = currentAdmin.name;
        } catch(e) {
            window.location.href = '/login. html';
            return;
        }

        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                switchTab(tab, this);
            });
        });

        updateTime();
        setInterval(updateTime, 1000);
        loadMembers();
    };

    function updateTime() {
        document.getElementById('clock').innerText = new Date().toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
    }

    function logout() {
        if(confirm('ç¡®å®šé€€å‡ºå—ï¼Ÿ')) {
            localStorage.removeItem('currentAdmin');
            window.location.href = '/login.html';
        }
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    function switchTab(tabName, menuElement) {
        document.querySelectorAll('.module-section').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(d => d.classList.remove('active'));


        const targetSection = document.getElementById(tabName + '-section');
        if (targetSection) {
            targetSection. classList.add('active');
        }

        if (menuElement) {
            menuElement.classList.add('active');
        }

        if(tabName === 'member') loadMembers();
        if(tabName === 'employee') loadEmployees();
        if(tabName === 'admin') loadAdmins();
        if(tabName === 'inventory') loadInventory();
        if(tabName === 'service') loadServices();
        if(tabName === 'appointment') loadApps();
        if(tabName === 'execution') loadExecutions();
        if(tabName === 'financial') loadFinancial();
    }

    async function handleApiError(response) {
        let errorMessage = "æ“ä½œå¤±è´¥";
        try {
            const errorData = await response.json();
            errorMessage = errorData.message || errorData.error || errorData.msg || "æœªçŸ¥é”™è¯¯";
        } catch(e) {
            try {
                errorMessage = await response.text() || `æ“ä½œå¤±è´¥ (HTTP ${response.status})`;
            } catch(e2) {
                errorMessage = `æ“ä½œå¤±è´¥ (HTTP ${response.status})`;
            }
        }
        return errorMessage;
    }

    // --- ä¼šå‘˜ ---
    function loadMembers() { fetch('/api/members').then(r=>r.json()).then(renderMemberTable).catch(e=>console.error('åŠ è½½ä¼šå‘˜å¤±è´¥:', e)); }
    function renderMemberTable(data) {
        let h = '';
        if(data.length===0) h='<tr><td colspan="6">æš‚æ— æ•°æ®</td></tr>';
        else data.forEach(m => h+=`<tr><td>${m.id}</td><td>${m. name}</td><td>${m. phone}</td><td>${m. gender}</td><td>Â¥${m.balance}</td><td><button class="btn-edit" onclick="openMemberModal('${m.id}','${m.name}','${m.phone}','${m.gender}')">ä¿®æ”¹</button><button class="btn-recharge" onclick="openRechargeModal(${m.id},'${m.name}',${m.balance})">ğŸ’°å……å€¼</button><button class="btn-del" onclick="delMember(${m.id})">åˆ é™¤</button></td></tr>`);
        document.querySelector('#memberTable tbody').innerHTML = h;
    }
    function searchMember() {
        const k=document.getElementById('searchMemberInput').value.trim();
        if(!k)return alert("è¯·è¾“å…¥æœç´¢å…³é”®è¯");
        fetch('/api/members/search? keyword='+k).then(r=>r.json()).then(renderMemberTable);
    }
    function resetMemberSearch() {
        document.getElementById('searchMemberInput').value='';
        loadMembers();
    }
    function openMemberModal(id,n,p,g){
        document.getElementById('editMemId').value=id;
        document.getElementById('editMemName').value=n;
        document.getElementById('editMemPhone').value=p;
        document.getElementById('editMemGender').value=g;
        document.getElementById('editMemberModal').style.display='block';
    }
    function submitEditMember(){
        const id=document.getElementById('editMemId').value,
              n=document.getElementById('editMemName').value,
              p=document.getElementById('editMemPhone').value,
              g=document.getElementById('editMemGender').value;
        if(!n||!p)return alert("ä¿¡æ¯ä¸å®Œæ•´");
        if(!PHONE_REGEX.test(p))return alert("æ‰‹æœºå·æ ¼å¼é”™è¯¯");
        fetch('/api/members/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body: JSON.stringify({id,name:n,phone:p,gender:g})}).then(()=>{alert("ä¿®æ”¹æˆåŠŸ");closeModal('editMemberModal');loadMembers();});
    }
    function addMember(){
        const n=document.getElementById('mName').value,
              p=document.getElementById('mPhone').value,
              g=document.getElementById('mGender').value;
        if(!n||!p)return alert("ä¿¡ä¸å®Œæ•´");
        if(!PHONE_REGEX.test(p))return alert("æ‰‹æœºå·æ ¼å¼é”™è¯¯");
        fetch('/api/members',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({name:n,phone:p,gender:g})}).then(()=>{alert("æ·»åŠ æˆåŠŸ");loadMembers();document.getElementById('mName').value='';document.getElementById('mPhone').value='';});
    }
    function delMember(id){
        if(confirm('ç¡®å®šåˆ é™¤? ')) fetch('/api/members/'+id,{method:'DELETE'}).then(()=>loadMembers());
    }

    // æ‰“å¼€å……å€¼å¼¹çª—
    function openRechargeModal(id, name, balance) {
        document.getElementById('rechargeMemId').value = id;
        document.getElementById('rechargeMemName').value = name;
        document.getElementById('rechargeMemBalance').value = 'Â¥' + balance;
        document.getElementById('rechargeAmount').value = '';
        document.getElementById('rechargeMemberModal').style.display = 'block';
    }

    // æäº¤å……å€¼
    function submitRecharge() {
        const id = document.getElementById('rechargeMemId').value;
        const amountStr = document.getElementById('rechargeAmount').value;
        
        if (!amountStr || amountStr.trim() === '') {
            return alert("è¯·è¾“å…¥å……å€¼é‡‘é¢");
        }
        
        const amount = parseFloat(amountStr);
        if (isNaN(amount) || amount <= 0) {
            return alert("å……å€¼é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        fetch('/api/members/' + id + '/simple-recharge', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({amount: amount})
        })
        .then(async response => {
            if (response.ok) {
                alert("âœ… å……å€¼æˆåŠŸï¼");
                closeModal('rechargeMemberModal');
                loadMembers();
            } else {
                const errorMsg = await handleApiError(response);
                alert("âŒ " + errorMsg);
            }
        })
        .catch(error => {
            console.error('å……å€¼å¤±è´¥:', error);
            alert("âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•");
        });
    }

    // --- å‘˜å·¥ ---
    function loadEmployees() { fetch('/api/employees').then(r=>r.json()).then(renderEmpTable).catch(e=>console.error('åŠ è½½å‘˜å·¥å¤±è´¥:', e)); }
    function renderEmpTable(data) {
        let h='';
        if(data.length===0)h='<tr><td colspan="5">æš‚æ— æ•°æ®</td></tr>';
        else data. forEach(e=>h+=`<tr><td>${e.id}</td><td>${e.name}</td><td>${e.phone}</td><td>${e.gender}</td><td><button class="btn-edit" onclick="openEmpModal(${e.id},'${e.name}','${e.phone}','${e. gender}')">ä¿®æ”¹</button><button class="btn-del" onclick="delEmployee(${e. id})">åˆ é™¤</button></td></tr>`);
        document.querySelector('#employeeTable tbody').innerHTML=h;
    }
    function searchEmployee(){
        const k=document.getElementById('searchEmpInput').value.trim();
        if(!k)return alert("è¯·è¾“å…¥æœç´¢å…³é”®è¯");
        fetch('/api/employees/search?keyword='+k).then(r=>r.json()).then(renderEmpTable);
    }
    function resetEmployeeSearch(){
        document.getElementById('searchEmpInput').value='';
        loadEmployees();
    }
    function openEmpModal(id,n,p,g){
        document.getElementById('editEmpId').value=id;
        document. getElementById('editEmpName').value=n;
        document.getElementById('editEmpPhone').value=p;
        document.getElementById('editEmpGender').value=g;
        document.getElementById('editEmpModal').style.display='block';
    }
    function submitEditEmployee(){
        const id=document. getElementById('editEmpId').value,
              n=document.getElementById('editEmpName').value,
              p=document.getElementById('editEmpPhone').value,
              g=document.getElementById('editEmpGender').value;
        if(!n||!p)return alert("ä¿¡æ¯ä¸å®Œæ•´");
        if(!PHONE_REGEX.test(p))return alert("æ‰‹æœºå·æ ¼å¼é”™è¯¯");
        fetch('/api/employees/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name:n,phone:p,gender:g})}).then(()=>{alert("ä¿®æ”¹æˆåŠŸ");closeModal('editEmpModal');loadEmployees();});
    }
    function addEmployee(){
        const n=document.getElementById('eName').value,
              p=document.getElementById('ePhone').value,
              g=document.getElementById('eGender').value;
        if(!n||!p)return alert("ä¿¡æ¯ä¸å®Œæ•´");
        if(!PHONE_REGEX.test(p))return alert("æ‰‹æœºå·æ ¼å¼é”™è¯¯");
        fetch('/api/employees',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,phone:p,gender:g})}).then(()=>{alert("æ·»åŠ æˆåŠŸ");loadEmployees();document.getElementById('eName').value='';document.getElementById('ePhone').value='';});
    }
    function delEmployee(id){
        if(confirm('ç¡®å®šåˆ é™¤? ')) fetch('/api/employees/'+id,{method:'DELETE'}).then(()=>loadEmployees());
    }

    // --- ç®¡ç†å‘˜ ---
    function loadAdmins(){
        fetch('/api/admins').then(r=>r.json()).then(d=>{
            let h='';
            d.forEach(a=>h+=`<tr><td>${a.id}</td><td>${a.name}</td><td>${a.phone}</td><td>${a.gender}</td><td><button class="btn-edit" onclick="openAdminModal(${a.id},'${a.name}','${a.phone}','${a. gender}')">ä¿®æ”¹</button><button class="btn-del" onclick="delAdmin(${a. id})">åˆ é™¤</button></td></tr>`);
            document.querySelector('#adminTable tbody').innerHTML=h;
        }).catch(e=>console.error('åŠ è½½ç®¡ç†å‘˜å¤±è´¥:', e));
    }
    function openAdminModal(id,n,p,g){
        document.getElementById('editAdminId').value=id;
        document.getElementById('editAdminName').value=n;
        document.getElementById('editAdminPhone').value=p;
        document.getElementById('editAdminGender').value=g;
        document.getElementById('editAdminModal').style.display='block';
    }
    function submitEditAdmin(){
        const id=document.getElementById('editAdminId').value,
              n=document.getElementById('editAdminName').value,
              p=document.getElementById('editAdminPhone').value,
              g=document. getElementById('editAdminGender').value;
        if(!n||!p)return alert("ä¿¡æ¯ä¸å®Œæ•´");
        if(!PHONE_REGEX.test(p))return alert("æ‰‹æœºå·æ ¼å¼é”™è¯¯");
        fetch('/api/admins',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name:n,phone:p,gender:g})}).then(r=>{if(r.ok){alert("ä¿®æ”¹æˆåŠŸ");closeModal('editAdminModal');loadAdmins();}else alert("ä¿®æ”¹å¤±è´¥")});
    }
    function addAdmin(){
        const n=document. getElementById('aName').value,
              p=document.getElementById('aPhone').value,
              g=document.getElementById('aGender').value;
        if(!n||!p)return alert("ä¿¡æ¯ä¸å®Œæ•´");
        if(!PHONE_REGEX.test(p))return alert("æ‰‹æœºå·æ ¼å¼é”™è¯¯");
        fetch('/api/admins',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({name:n,phone:p,gender:g})}).then(r=>{if(r.ok){alert("æ·»åŠ æˆåŠŸ");loadAdmins();document.getElementById('aName').value='';document.getElementById('aPhone').value='';}else alert("æ·»åŠ å¤±è´¥")});
    }
    function delAdmin(id){
        if(confirm('ç¡®å®šåˆ é™¤?')) fetch(`/api/admins/${id}? currentAdminId=${currentAdmin.id}`,{method:'DELETE'}).then(r=>{if(r. ok)loadAdmins();else alert("åˆ é™¤å¤±è´¥")});
    }

    // --- åº“å­˜ ---
    function loadInventory(){
        document.getElementById('searchInv').value='';
        fetch('/api/inventory').then(r=>r.json()).then(renderInvTable).catch(e=>console.error('åŠ è½½åº“å­˜å¤±è´¥:', e));
    }
    function renderInvTable(data){
        let h='';
        if(data.length===0)h='<tr><td colspan="6">æš‚æ— æ•°æ®</td></tr>';
        else data.forEach(i=>{
            let remarkStyle = i.remark&&i.remark.includes('ä¸è¶³')?'color:red':'color:green';
            h+=`<tr><td>${i.id}</td><td>${i.name}</td><td>${i.quantity}</td><td>${i.threshold}</td><td style="${remarkStyle}">${i.remark||''}</td><td><button class="btn-edit" onclick="openInvModal(${i.id},'${i.name}',${i.quantity},${i.threshold})">ä¿®æ”¹</button><button class="btn-del" onclick="delInventory(${i.id})">åˆ é™¤</button></td></tr>`;
        });
        document.querySelector('#inventoryTable tbody').innerHTML=h;
    }
    function searchInventory(){
        const k=document.getElementById('searchInv').value.trim();
        if(!k)return loadInventory();
        fetch('/api/inventory/search?keyword='+k).then(r=>r.json()).then(renderInvTable);
    }
    function addInventory(){
        const n=document.getElementById('iName').value,
              q=document.getElementById('iQty').value,
              t=document.getElementById('iThreshold').value;
        if(!n||!q||!t)return alert("ä¿¡æ¯ä¸å®Œæ•´");
        fetch('/api/inventory',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,quantity:q,threshold:t})}).then(()=>{alert("æ·»åŠ æˆåŠŸ");loadInventory();document.getElementById('iName').value='';document.getElementById('iQty').value='';document.getElementById('iThreshold').value='';});
    }
    function openInvModal(id,n,q,t){
        document.getElementById('eiId').value=id;
        document.getElementById('eiName').value=n;
        document. getElementById('eiQty').value=q;
        document.getElementById('eiThreshold').value=t;
        document.getElementById('editInvModal').style.display='block';
    }
    function submitEditInv(){
        const id=document.getElementById('eiId').value,
              n=document.getElementById('eiName').value,
              q=document.getElementById('eiQty').value,
              t=document.getElementById('eiThreshold').value;
        if(q<0||t<0)return alert("æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°");
        fetch('/api/inventory',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name:n,quantity:q,threshold:t})}).then(()=>{alert("ä¿®æ”¹æˆåŠŸ");closeModal('editInvModal');loadInventory();});
    }
    function delInventory(id){
        if(confirm('ç¡®å®šåˆ é™¤? ')) fetch('/api/inventory/'+id,{method:'DELETE'}).then(()=>loadInventory());
    }

    // --- æœåŠ¡ ---
    function loadServices(){
        document.getElementById('searchServiceInput').value='';
        fetch('/api/services').then(r=>r.json()).then(renderServiceTable).catch(e=>console.error('åŠ è½½æœåŠ¡å¤±è´¥:', e));
        fetch('/api/inventory').then(r=>r.json()).then(d=>{inventoryCache=d;});
    }
    function renderServiceTable(data){
        let h='';
        if(data. length===0)h='<tr><td colspan="6">æš‚æ— æ•°æ®</td></tr>';
        else data.forEach(s=>{
            h+=`<tr><td>${s.id}</td><td>${s.name}</td><td style="color:#d35400">Â¥${s.price}</td><td>${s.duration}åˆ†</td><td style="font-size:12px">${s.consumeItemIds||'æ— '}</td><td><button class="btn-edit" onclick="openEditService(${s.id},'${s.name}',${s.price},${s. duration},'${s.consumeItemIds||''}')">ä¿®æ”¹</button><button class="btn-del" onclick="delService(${s.id})">åˆ é™¤</button></td></tr>`;
        });
        document.querySelector('#serviceTable tbody').innerHTML=h;
    }
    function searchService(){
        const k=document.getElementById('searchServiceInput').value.trim();
        if(!k)return loadServices();
        fetch('/api/services/search?keyword='+k).then(r=>r.json()).then(renderServiceTable);
    }
    function fillItemSelects(idsStr){
        let arr=[];
        if(idsStr) arr=idsStr.split(',').map(Number);
        for(let i=1;i<=5;i++){
            const sel=document.getElementById('svcItem'+i);
            sel.innerHTML='<option value="">-- æ— æ¶ˆè€— --</option>';
            inventoryCache.forEach(it=>{
                const op=document.createElement('option');
                op.value=it.id;
                op.innerText=it.name;
                if(arr[i-1]===it.id)op.selected=true;
                sel.appendChild(op);
            });
        }
    }
    function openAddServiceModal(){
        document.getElementById('serviceModalTitle').innerText="æ–°å¢æœåŠ¡";
        document. getElementById('svcId').value='';
        document.getElementById('svcName').value='';
        document.getElementById('svcPrice').value='';
        document.getElementById('svcDuration').value='60';
        fillItemSelects("");
        document.getElementById('serviceModal').style.display='block';
    }
    function openEditService(id,n,p,d,ids){
        document.getElementById('serviceModalTitle').innerText="ä¿®æ”¹æœåŠ¡";
        document.getElementById('svcId').value=id;
        document.getElementById('svcName').value=n;
        document.getElementById('svcPrice').value=p;
        document.getElementById('svcDuration').value=d;
        fillItemSelects(ids||"");
        document.getElementById('serviceModal').style.display='block';
    }
    function submitService(){
        const id=document. getElementById('svcId').value,
              n=document.getElementById('svcName').value,
              p=document.getElementById('svcPrice').value,
              d=document.getElementById('svcDuration').value;
        let ids=[];
        for(let i=1;i<=5;i++){
            const v=document.getElementById('svcItem'+i).value;
            if(v)ids.push(v);
        }
        if(! n||!p||!d)return alert("ä¿¡æ¯ä¸å®Œæ•´");
        const m=id?'PUT':'POST';
        const u=id?('/api/services/'+id):'/api/services';
        fetch(u,{method:m,headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,price:p,duration:d,consumeItemIds:ids. join(',')})}).then(async r=>{
            if(r. ok){
                alert("âœ… æ“ä½œæˆåŠŸ");
                closeModal('serviceModal');
                loadServices();
            } else {
                const errorMsg = await handleApiError(r);
                alert("âŒ " + errorMsg);
            }
        });
    }
    function delService(id){
        if(confirm('ç¡®å®šåˆ é™¤?')) fetch('/api/services/'+id,{method:'DELETE'}).then(()=>loadServices());
    }

    // --- é¢„çº¦ ---
    function loadApps() {
        document.getElementById('searchAppInput').value = '';
        fetch('/api/appointments').then(r=>r.json()).then(renderAppTable).catch(e=>console.error('åŠ è½½é¢„çº¦å¤±è´¥:', e));
    }
    function renderAppTable(data) {
        let h = '';
        if(data.length===0) h='<tr><td colspan="9" style="text-align:center">æš‚æ— é¢„çº¦</td></tr>';
        else data.forEach(a => {
            let statusColor = '#333';
            if(a.status==='å¾…æœåŠ¡')statusColor='#f39c12';
            if(a.status==='å·²æœåŠ¡')statusColor='#27ae60';
            if(a.status==='å·²å–æ¶ˆ')statusColor='#999';

            let btns = '';
            if(a. status==='å¾…æœåŠ¡') {
                btns = `<button style="background:#28a745;padding:4px 8px;font-size:12px" onclick="changeAppStatus(${a.id},'complete')">âœ… å·²æœåŠ¡</button>
                        <button style="background:#6c757d;padding:4px 8px;font-size:12px" onclick="changeAppStatus(${a.id},'cancel')">ğŸš« å–æ¶ˆ</button>`;
            } else btns='<span style="color:#ccc;font-size:12px">ä¸å¯æ“ä½œ</span>';

            h += `<tr><td>${a.id}</td><td>${a. appointmentDate}</td><td>${a.timeRange}</td><td>${a.memberName}</td><td>${a. serviceName}</td><td>${a. employeeName}</td><td style="color:#888;font-size:12px">${a.remark||'-'}</td><td style="color:${statusColor};font-weight:bold">${a.status}</td><td>${btns} <button class="btn-del" style="padding:4px 8px;font-size:12px" onclick="delApp(${a.id})">åˆ é™¤</button></td></tr>`;
        });
        document.querySelector('#appTable tbody').innerHTML = h;
    }
    function searchApp() {
        const k=document.getElementById('searchAppInput').value.trim();
        if(!k)return loadApps();
        fetch('/api/appointments/search?keyword='+k).then(r=>r.json()).then(renderAppTable);
    }
    function openAddAppModal() {
        document. getElementById('appDate').valueAsDate = new Date();
        document.getElementById('appStartHour').value = '';

        Promise.all([
            fetch('/api/members').then(r=>r.json()),
            fetch('/api/services').then(r=>r.json()),
            fetch('/api/employees').then(r=>r.json())
        ])
        .then(([members, services, employees])=>{
            let h1='<option value="">--è¯·é€‰æ‹©--</option>';
            members.forEach(x=>h1+=`<option value="${x.id}">${x. name}</option>`);
            document.getElementById('appMemberId').innerHTML=h1;

            let h2='<option value="">--è¯·é€‰æ‹©--</option>';
            services.forEach(x=>h2+=`<option value="${x.id}">${x.name} (${x.duration}åˆ†)</option>`);
            document.getElementById('appServiceId').innerHTML=h2;

            let h3='<option value="">--è¯·é€‰æ‹©--</option>';
            employees.forEach(x=>h3+=`<option value="${x.id}">${x.name}</option>`);
            document.getElementById('appEmployeeId').innerHTML=h3;

            document.getElementById('addAppModal').style.display='block';
        })
        .catch(e=>console.error('åŠ è½½é¢„çº¦æ•°æ®å¤±è´¥:', e));
    }
    function submitApp() {
        const d=document.getElementById('appDate').value,
              sh=document.getElementById('appStartHour').value,
              m=document.getElementById('appMemberId').value,
              svc=document.getElementById('appServiceId').value,
              e=document.getElementById('appEmployeeId').value;
        if(!d||!sh||!m||!svc||!e) return alert("ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹");

        fetch('/api/appointments', {
            method:'POST',
            headers:  {'Content-Type':'application/json'},
            body: JSON.stringify({date:d, startHour:sh, memberId:m, serviceId:svc, employeeId:e})
        })
        .then(async response => {
            if(response. ok) {
                alert("âœ… é¢„çº¦æˆåŠŸï¼");
                closeModal('addAppModal');
                loadApps();
            } else {
                const errorMsg = await handleApiError(response);
                alert("âŒ " + errorMsg);
            }
        })
        .catch(error => {
            console.error('é¢„çº¦è¯·æ±‚å¤±è´¥:', error);
            alert("âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•");
        });
    }
    function changeAppStatus(id,act) {
        if(confirm(act==='complete'? 'ç¡®è®¤å®Œæˆ?  (å°†æ‰£é™¤åº“å­˜)':'ç¡®è®¤å–æ¶ˆ? '))
            fetch(`/api/appointments/${id}/${act}`,{method:'POST'}).then(()=>loadApps());
    }
    function delApp(id) {
        if(confirm('åˆ é™¤ä¸å¯æ¢å¤, ç¡®å®š? '))
            fetch('/api/appointments/'+id,{method:'DELETE'}).then(()=>loadApps());
    }

    // --- æœåŠ¡æ‰§è¡Œç®¡ç† ---
    function loadExecutions() {
        // æ¸…ç©ºç­›é€‰æ¡ä»¶
        document.getElementById('filterMemberId').value = '';
        document.getElementById('filterServiceId').value = '';
        document.getElementById('filterEmployeeId').value = '';
        document.getElementById('filterServiceDate').value = '';
        
        // åŠ è½½ç­›é€‰ä¸‹æ‹‰æ¡†æ•°æ®
        Promise.all([
            fetch('/api/members').then(r=>r.json()),
            fetch('/api/services').then(r=>r.json()),
            fetch('/api/employees').then(r=>r.json())
        ]).then(([members, services, employees]) => {
            // å¡«å……ä¼šå‘˜ä¸‹æ‹‰æ¡†
            let memberOptions = '<option value="">å…¨éƒ¨ä¼šå‘˜</option>';
            members.forEach(m => memberOptions += `<option value="${m.id}">${m.name} (ID:${m.id})</option>`);
            document.getElementById('filterMemberId').innerHTML = memberOptions;
            
            // å¡«å……æœåŠ¡ä¸‹æ‹‰æ¡†
            let serviceOptions = '<option value="">å…¨éƒ¨æœåŠ¡</option>';
            services.forEach(s => serviceOptions += `<option value="${s.id}">${s.name} (ID:${s.id})</option>`);
            document.getElementById('filterServiceId').innerHTML = serviceOptions;
            
            // å¡«å……å‘˜å·¥ä¸‹æ‹‰æ¡†
            let employeeOptions = '<option value="">å…¨éƒ¨å‘˜å·¥</option>';
            employees.forEach(e => employeeOptions += `<option value="${e.id}">${e.name} (ID:${e.id})</option>`);
            document.getElementById('filterEmployeeId').innerHTML = employeeOptions;
        }).catch(e => console.error('åŠ è½½ç­›é€‰æ•°æ®å¤±è´¥:', e));
        
        // åŠ è½½æ‰§è¡Œè®°å½•åˆ—è¡¨
        fetch('/api/service-executions')
            .then(r => r.json())
            .then(renderExecutionTable)
            .catch(e => console.error('åŠ è½½æœåŠ¡æ‰§è¡Œè®°å½•å¤±è´¥:', e));
    }

    function renderExecutionTable(data) {
        let html = '';
        if (data.length === 0) {
            html = '<tr><td colspan="10" style="text-align:center">æš‚æ— æœåŠ¡æ‰§è¡Œè®°å½•</td></tr>';
        } else {
            data.forEach(exec => {
                html += `<tr>
                    <td>${exec.id}</td>
                    <td>${exec.memberId}</td>
                    <td>${exec.memberName}</td>
                    <td>${exec.serviceId}</td>
                    <td>${exec.serviceName}</td>
                    <td>${exec.employeeId}</td>
                    <td>${exec.employeeName || '-'}</td>
                    <td style="color:#d35400;font-weight:bold">Â¥${exec.cost}</td>
                    <td>${exec.serviceDate}</td>
                    <td>
                        <button class="btn-edit" onclick="openEditExecutionModal(${exec.id})">ä¿®æ”¹</button>
                        <button class="btn-del" onclick="delExecution(${exec.id})">åˆ é™¤</button>
                    </td>
                </tr>`;
            });
        }
        document.querySelector('#executionTable tbody').innerHTML = html;
    }

    function searchExecution() {
        const memberId = document.getElementById('filterMemberId').value;
        const serviceId = document.getElementById('filterServiceId').value;
        const employeeId = document.getElementById('filterEmployeeId').value;
        const serviceDate = document.getElementById('filterServiceDate').value;
        
        // æ„å»ºæŸ¥è¯¢å‚æ•°
        let params = new URLSearchParams();
        if (memberId) params.append('memberId', memberId);
        if (serviceId) params.append('serviceId', serviceId);
        if (employeeId) params.append('employeeId', employeeId);
        if (serviceDate) params.append('serviceDate', serviceDate);
        
        const url = '/api/service-executions/search' + (params.toString() ? '?' + params.toString() : '');
        fetch(url)
            .then(r => r.json())
            .then(renderExecutionTable)
            .catch(e => console.error('æŸ¥è¯¢å¤±è´¥:', e));
    }

    function resetExecutionSearch() {
        loadExecutions();
    }

    function openAddExecutionModal() {
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('execServiceDate').valueAsDate = new Date();
        
        // åŠ è½½ä¼šå‘˜ã€æœåŠ¡ã€å‘˜å·¥ä¸‹æ‹‰æ¡†
        Promise.all([
            fetch('/api/members').then(r => r.json()),
            fetch('/api/services').then(r => r.json()),
            fetch('/api/employees').then(r => r.json())
        ]).then(([members, services, employees]) => {
            let memberHtml = '<option value="">--è¯·é€‰æ‹©ä¼šå‘˜--</option>';
            members.forEach(m => memberHtml += `<option value="${m.id}">${m.name}</option>`);
            document.getElementById('execMemberId').innerHTML = memberHtml;
            
            let serviceHtml = '<option value="">--è¯·é€‰æ‹©æœåŠ¡--</option>';
            services.forEach(s => serviceHtml += `<option value="${s.id}">${s.name} (Â¥${s.price})</option>`);
            document.getElementById('execServiceId').innerHTML = serviceHtml;
            
            let employeeHtml = '<option value="">--è¯·é€‰æ‹©å‘˜å·¥--</option>';
            employees.forEach(e => employeeHtml += `<option value="${e.id}">${e.name}</option>`);
            document.getElementById('execEmployeeId').innerHTML = employeeHtml;
            
            document.getElementById('addExecutionModal').style.display = 'block';
        }).catch(e => console.error('åŠ è½½æ•°æ®å¤±è´¥:', e));
    }

    function submitExecution() {
        const memberId = document.getElementById('execMemberId').value;
        const serviceId = document.getElementById('execServiceId').value;
        const employeeId = document.getElementById('execEmployeeId').value;
        const serviceDate = document.getElementById('execServiceDate').value;
        
        if (!memberId || !serviceId || !employeeId) {
            return alert("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼ˆä¼šå‘˜ã€æœåŠ¡é¡¹ç›®ã€å‘˜å·¥ï¼‰");
        }
        
        fetch('/api/service-executions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                memberId: memberId,
                serviceId: serviceId,
                employeeId: employeeId,
                serviceDate: serviceDate || null
            })
        })
        .then(async response => {
            if (response.ok) {
                alert("âœ… æ–°å¢æˆåŠŸï¼");
                closeModal('addExecutionModal');
                loadExecutions();
            } else {
                const errorMsg = await handleApiError(response);
                alert("âŒ " + errorMsg);
            }
        })
        .catch(error => {
            console.error('æ–°å¢å¤±è´¥:', error);
            alert("âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•");
        });
    }

    function openEditExecutionModal(id) {
        // å…ˆè·å–å½“å‰è®°å½•
        fetch('/api/service-executions')
            .then(r => r.json())
            .then(executions => {
                const exec = executions.find(e => e.id === id);
                if (!exec) {
                    alert("è®°å½•ä¸å­˜åœ¨");
                    return;
                }
                
                document.getElementById('editExecId').value = exec.id;
                document.getElementById('editExecServiceDate').value = exec.serviceDate;
                
                // åŠ è½½ä¸‹æ‹‰æ¡†å¹¶è®¾ç½®å½“å‰å€¼
                Promise.all([
                    fetch('/api/members').then(r => r.json()),
                    fetch('/api/services').then(r => r.json()),
                    fetch('/api/employees').then(r => r.json())
                ]).then(([members, services, employees]) => {
                    let memberHtml = '<option value="">--è¯·é€‰æ‹©ä¼šå‘˜--</option>';
                    members.forEach(m => {
                        const selected = m.id === exec.memberId ? 'selected' : '';
                        memberHtml += `<option value="${m.id}" ${selected}>${m.name}</option>`;
                    });
                    document.getElementById('editExecMemberId').innerHTML = memberHtml;
                    
                    let serviceHtml = '<option value="">--è¯·é€‰æ‹©æœåŠ¡--</option>';
                    services.forEach(s => {
                        const selected = s.id === exec.serviceId ? 'selected' : '';
                        serviceHtml += `<option value="${s.id}" ${selected}>${s.name} (Â¥${s.price})</option>`;
                    });
                    document.getElementById('editExecServiceId').innerHTML = serviceHtml;
                    
                    let employeeHtml = '<option value="">--è¯·é€‰æ‹©å‘˜å·¥--</option>';
                    employees.forEach(e => {
                        const selected = e.id === exec.employeeId ? 'selected' : '';
                        employeeHtml += `<option value="${e.id}" ${selected}>${e.name}</option>`;
                    });
                    document.getElementById('editExecEmployeeId').innerHTML = employeeHtml;
                    
                    document.getElementById('editExecutionModal').style.display = 'block';
                }).catch(e => console.error('åŠ è½½æ•°æ®å¤±è´¥:', e));
            })
            .catch(e => console.error('è·å–è®°å½•å¤±è´¥:', e));
    }

    function submitEditExecution() {
        const id = document.getElementById('editExecId').value;
        const memberId = document.getElementById('editExecMemberId').value;
        const serviceId = document.getElementById('editExecServiceId').value;
        const employeeId = document.getElementById('editExecEmployeeId').value;
        const serviceDate = document.getElementById('editExecServiceDate').value;
        
        if (!memberId || !serviceId || !employeeId) {
            return alert("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼ˆä¼šå‘˜ã€æœåŠ¡é¡¹ç›®ã€å‘˜å·¥ï¼‰");
        }
        
        fetch(`/api/service-executions/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                memberId: memberId,
                serviceId: serviceId,
                employeeId: employeeId,
                serviceDate: serviceDate || null
            })
        })
        .then(async response => {
            if (response.ok) {
                alert("âœ… ä¿®æ”¹æˆåŠŸï¼");
                closeModal('editExecutionModal');
                loadExecutions();
            } else {
                const errorMsg = await handleApiError(response);
                alert("âŒ " + errorMsg);
            }
        })
        .catch(error => {
            console.error('ä¿®æ”¹å¤±è´¥:', error);
            alert("âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•");
        });
    }

    function delExecution(id) {
        if (confirm('ç¡®å®šåˆ é™¤æ­¤æœåŠ¡æ‰§è¡Œè®°å½•å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼')) {
            fetch(`/api/service-executions/${id}`, {method: 'DELETE'})
                .then(() => {
                    alert("âœ… åˆ é™¤æˆåŠŸï¼");
                    loadExecutions();
                })
                .catch(e => {
                    console.error('åˆ é™¤å¤±è´¥:', e);
                    alert("âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•");
                });
        }
    }

    // --- è´¢åŠ¡ç®¡ç† ---
    function loadFinancial() {
        // åŠ è½½æœåŠ¡æ”¶å…¥
        loadIncome();
        // åŠ è½½é‡‡è´­æ”¯å‡º
        loadPurchase();
        // åŠ è½½åº“å­˜ç‰©å“åˆ—è¡¨ç”¨äºé‡‡è´­ä¸‹æ‹‰é€‰æ‹©
        loadInventoryForPurchase();
        // åŠ è½½ç­›é€‰æ¡ä»¶çš„ä¸‹æ‹‰é€‰é¡¹
        loadIncomeFilters();
    }

    // æœåŠ¡æ”¶å…¥
    function loadIncome() {
        const memberId = document.getElementById('incomeFilterMemberId').value;
        const serviceId = document.getElementById('incomeFilterServiceId').value;
        const employeeId = document.getElementById('incomeFilterEmployeeId').value;
        const serviceDate = document.getElementById('incomeFilterDate').value;
        
        let url = '/api/financial/income?';
        if (memberId) url += `memberId=${memberId}&`;
        if (serviceId) url += `serviceId=${serviceId}&`;
        if (employeeId) url += `employeeId=${employeeId}&`;
        if (serviceDate) url += `serviceDate=${serviceDate}&`;
        
        fetch(url)
            .then(r => r.json())
            .then(data => {
                renderIncomeTable(data.records);
                document.getElementById('totalIncome').innerText = 'Â¥' + (data.totalIncome || 0).toFixed(2);
            })
            .catch(e => console.error('åŠ è½½æœåŠ¡æ”¶å…¥å¤±è´¥:', e));
    }

    function renderIncomeTable(records) {
        let html = '';
        if (records.length === 0) {
            html = '<tr><td colspan="6" style="text-align:center">æš‚æ— æœåŠ¡æ”¶å…¥è®°å½•</td></tr>';
        } else {
            records.forEach(r => {
                html += `<tr>
                    <td>${r.id}</td>
                    <td>${r.memberId}</td>
                    <td>${r.serviceId}</td>
                    <td>${r.employeeId}</td>
                    <td style="color:#27ae60; font-weight:bold;">Â¥${r.cost}</td>
                    <td>${r.serviceDate}</td>
                </tr>`;
            });
        }
        document.querySelector('#incomeTable tbody').innerHTML = html;
    }

    function searchIncome() {
        loadIncome();
    }

    function resetIncomeSearch() {
        document.getElementById('incomeFilterMemberId').value = '';
        document.getElementById('incomeFilterServiceId').value = '';
        document.getElementById('incomeFilterEmployeeId').value = '';
        document.getElementById('incomeFilterDate').value = '';
        loadIncome();
    }

    function loadIncomeFilters() {
        // åŠ è½½ä¼šå‘˜åˆ—è¡¨
        fetch('/api/members')
            .then(r => r.json())
            .then(data => {
                let html = '<option value="">å…¨éƒ¨ä¼šå‘˜</option>';
                data.forEach(m => {
                    html += `<option value="${m.id}">${m.id} - ${m.name}</option>`;
                });
                document.getElementById('incomeFilterMemberId').innerHTML = html;
            });
        
        // åŠ è½½æœåŠ¡åˆ—è¡¨
        fetch('/api/services')
            .then(r => r.json())
            .then(data => {
                let html = '<option value="">å…¨éƒ¨æœåŠ¡</option>';
                data.forEach(s => {
                    html += `<option value="${s.id}">${s.id} - ${s.name}</option>`;
                });
                document.getElementById('incomeFilterServiceId').innerHTML = html;
            });
        
        // åŠ è½½å‘˜å·¥åˆ—è¡¨
        fetch('/api/employees')
            .then(r => r.json())
            .then(data => {
                let html = '<option value="">å…¨éƒ¨å‘˜å·¥</option>';
                data.forEach(e => {
                    html += `<option value="${e.id}">${e.id} - ${e.name}</option>`;
                });
                document.getElementById('incomeFilterEmployeeId').innerHTML = html;
            });
    }

    // é‡‡è´­æ”¯å‡º
    function loadPurchase() {
        const inventoryId = document.getElementById('purchaseFilterInventoryId').value;
        const purchaseDate = document.getElementById('purchaseFilterDate').value;
        
        let url = '/api/financial/purchase?';
        if (inventoryId) url += `inventoryId=${inventoryId}&`;
        if (purchaseDate) url += `purchaseDate=${purchaseDate}&`;
        
        fetch(url)
            .then(r => r.json())
            .then(data => {
                renderPurchaseTable(data.records);
                document.getElementById('totalExpenditure').innerText = 'Â¥' + (data.totalExpenditure || 0).toFixed(2);
            })
            .catch(e => console.error('åŠ è½½é‡‡è´­è®°å½•å¤±è´¥:', e));
    }

    function renderPurchaseTable(records) {
        let html = '';
        if (records.length === 0) {
            html = '<tr><td colspan="8" style="text-align:center">æš‚æ— é‡‡è´­è®°å½•</td></tr>';
        } else {
            records.forEach(r => {
                html += `<tr>
                    <td>${r.id}</td>
                    <td>${r.inventoryId}</td>
                    <td>${r.inventoryName}</td>
                    <td>${r.quantity}</td>
                    <td>Â¥${r.unitPrice}</td>
                    <td style="color:#e74c3c; font-weight:bold;">Â¥${r.totalPrice}</td>
                    <td>${r.purchaseDate}</td>
                    <td><button class="btn-del" onclick="delPurchase(${r.id})">åˆ é™¤</button></td>
                </tr>`;
            });
        }
        document.querySelector('#purchaseTable tbody').innerHTML = html;
    }

    function searchPurchase() {
        loadPurchase();
    }

    function resetPurchaseSearch() {
        document.getElementById('purchaseFilterInventoryId').value = '';
        document.getElementById('purchaseFilterDate').value = '';
        loadPurchase();
    }

    function loadInventoryForPurchase() {
        fetch('/api/inventory')
            .then(r => r.json())
            .then(data => {
                let html = '<option value="">è¯·é€‰æ‹©ç‰©å“...</option>';
                data.forEach(i => {
                    html += `<option value="${i.id}">${i.id} - ${i.name}</option>`;
                });
                document.getElementById('purchaseInventoryId').innerHTML = html;
                // ä¹Ÿæ›´æ–°ç­›é€‰æ¡ä»¶çš„ä¸‹æ‹‰æ¡†
                let filterHtml = '<option value="">å…¨éƒ¨ç‰©å“</option>';
                data.forEach(i => {
                    filterHtml += `<option value="${i.id}">${i.id} - ${i.name}</option>`;
                });
                document.getElementById('purchaseFilterInventoryId').innerHTML = filterHtml;
            });
    }

    function openAddPurchaseModal() {
        // é‡ç½®è¡¨å•
        document.getElementById('purchaseInventoryId').value = '';
        document.getElementById('purchaseQuantity').value = '';
        document.getElementById('purchaseUnitPrice').value = '';
        document.getElementById('addPurchaseModal').style.display = 'block';
    }

    function submitPurchase() {
        const inventoryId = document.getElementById('purchaseInventoryId').value;
        const quantity = document.getElementById('purchaseQuantity').value;
        const unitPrice = document.getElementById('purchaseUnitPrice').value;
        
        if (!inventoryId) {
            return alert("è¯·é€‰æ‹©ç‰©å“");
        }
        if (!quantity || quantity <= 0) {
            return alert("é‡‡è´­æ•°é‡å¿…é¡»å¤§äº0");
        }
        if (!unitPrice || unitPrice <= 0) {
            return alert("å•ä»·å¿…é¡»å¤§äº0");
        }
        
        fetch('/api/financial/purchase', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                inventoryId: parseInt(inventoryId),
                quantity: parseInt(quantity),
                unitPrice: parseFloat(unitPrice)
            })
        })
        .then(async response => {
            if (response.ok) {
                alert("âœ… é‡‡è´­æˆåŠŸï¼åº“å­˜å·²æ›´æ–°");
                closeModal('addPurchaseModal');
                loadPurchase();
            } else {
                const errorMsg = await handleApiError(response);
                alert("âŒ " + errorMsg);
            }
        })
        .catch(error => {
            console.error('é‡‡è´­å¤±è´¥:', error);
            alert("âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•");
        });
    }

    function delPurchase(id) {
        if (confirm('ç¡®å®šåˆ é™¤æ­¤é‡‡è´­è®°å½•å—ï¼Ÿæ³¨æ„ï¼šåˆ é™¤è®°å½•ä¸ä¼šå›é€€åº“å­˜ï¼')) {
            fetch(`/api/financial/purchase/${id}`, {method: 'DELETE'})
                .then(() => {
                    alert("âœ… åˆ é™¤æˆåŠŸï¼");
                    loadPurchase();
                })
                .catch(e => {
                    console.error('åˆ é™¤å¤±è´¥:', e);
                    alert("âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•");
                });
        }
    }

</script>

</body>
</html>