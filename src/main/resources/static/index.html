<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç†å‘åº—ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background: #f4f6f8; }
        .sidebar { width: 220px; background: #2c3e50; color: white; display: flex; flex-direction: column; }
        .sidebar h2 { text-align: center; padding: 20px 0; border-bottom: 1px solid #34495e; margin: 0; font-size: 18px; }
        .menu-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #34495e; transition: 0.3; }
        .menu-item:hover, .menu-item.active { background: #34495e; border-left: 4px solid #3498db; }
        .user-info { margin-top: auto; padding: 20px; font-size: 14px; background: #1a252f; }
        .logout { color: #e74c3c; cursor: pointer; text-decoration: underline; margin-left: 10px; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .calendar-box { font-weight: bold; color: #555; font-size: 16px; }
        .module-section { display: none; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .module-section.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        input, select { padding: 8px; border: 1px solid #ddd; margin-right: 5px; border-radius: 4px; }
        button { padding: 8px 12px; border: none; border-radius: 4px; color: white; cursor: pointer; }
        .btn-add { background: #28a745; }
        .btn-del { background: #dc3545; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-search { background: #17a2b8; }
        .btn-cancel { background: #6c757d; }
        .search-box { background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px; border: 1px solid #eee; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 8px; width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .form-group input, .form-group select { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .modal-footer { text-align: right; margin-top: 20px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>ğŸ’ˆ æ‚¦å®¹ç†å‘åº—</h2>
    <div class="menu-item active" onclick="switchTab('member')">ğŸ‘¤ ä¼šå‘˜ç®¡ç†</div>
    <div class="menu-item" onclick="switchTab('employee')">ğŸ‘” å‘˜å·¥ç®¡ç†</div>
    <div class="menu-item" onclick="switchTab('admin')">ğŸ›¡ï¸ ç®¡ç†å‘˜ç®¡ç†</div>
    <div class="menu-item" onclick="switchTab('inventory')">ğŸ“¦ åº“å­˜ç®¡ç†</div>
    <div class="menu-item" onclick="switchTab('service')">ğŸ’‡ æœåŠ¡é¡¹ç›®ç®¡ç†</div>
    <div class="menu-item" onclick="switchTab('appointment')">ğŸ“… é¢„çº¦ç®¡ç†</div>
    <div class="user-info">
        å½“å‰ç”¨æˆ·ï¼š<span id="currentAdminName">...</span>
        <span class="logout" onclick="logout()">é€€å‡º</span>
    </div>
</div>

<div class="main-content">
    <div class="top-bar">
        <div>æ¬¢è¿ä½¿ç”¨ç®¡ç†ç³»ç»Ÿ</div>
        <div class="calendar-box">ğŸ“… å½“å‰æ—¶é—´ï¼š<span id="clock"></span></div>
    </div>

    <!-- 1. ä¼šå‘˜ -->
    <div id="member-section" class="module-section active">
        <h3>ğŸ‘¤ ä¼šå‘˜ç®¡ç†</h3>
        <div class="search-box">
            <input type="text" id="searchMemberInput" placeholder="è¾“å…¥æ‰‹æœºå·æŸ¥è¯¢..." style="width: 200px;">
            <button class="btn-search" onclick="searchMember()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="resetMemberSearch()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <input type="text" id="mName" placeholder="å§“å">
            <input type="text" id="mPhone" placeholder="æ‰‹æœºå·">
            <select id="mGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <button class="btn-add" onclick="addMember()">+ æ–°å¢ä¼šå‘˜</button>
        </div>
        <table id="memberTable">
            <thead><tr><th>ID</th><th>å§“å</th><th>æ‰‹æœº</th><th>æ€§åˆ«</th><th>ä½™é¢</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 2. å‘˜å·¥ -->
    <div id="employee-section" class="module-section">
        <h3>ğŸ‘” å‘˜å·¥ç®¡ç†</h3>
        <div class="search-box">
            <input type="text" id="searchEmpInput" placeholder="è¾“å…¥å·¥å·æˆ–æ‰‹æœºå·æŸ¥è¯¢" style="width: 200px;">
            <button class="btn-search" onclick="searchEmployee()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="resetEmployeeSearch()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <input type="text" id="eName" placeholder="å‘˜å·¥å§“å">
            <input type="text" id="ePhone" placeholder="å‘˜å·¥æ‰‹æœº">
            <select id="eGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <button class="btn-add" onclick="addEmployee()">+ æ–°å¢å‘˜å·¥</button>
        </div>
        <table id="employeeTable">
            <thead><tr><th>å·¥å· (ID)</th><th>å§“å</th><th>æ‰‹æœºå·</th><th>æ€§åˆ«</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 3. ç®¡ç†å‘˜ -->
    <div id="admin-section" class="module-section">
        <h3>ğŸ›¡ï¸ ç®¡ç†å‘˜æ¡£æ¡ˆ</h3>
        <div style="margin-bottom: 15px;">
            <input type="text" id="aName" placeholder="ç®¡ç†å‘˜å§“å">
            <input type="text" id="aPhone" placeholder="ç™»å½•æ‰‹æœºå·">
            <select id="aGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
            <button class="btn-add" onclick="addAdmin()">+ æ–°å¢ç®¡ç†å‘˜</button>
        </div>
        <table id="adminTable">
            <thead><tr><th>ID</th><th>å§“å</th><th>ç™»å½•æ‰‹æœº</th><th>æ€§åˆ«</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 4. åº“å­˜ -->
    <div id="inventory-section" class="module-section">
        <h3>ğŸ“¦ åº“å­˜ç®¡ç†</h3>
        <div class="search-box">
            <input type="text" id="searchInv" placeholder="è¾“å…¥ç‰©å“åç§°æˆ–IDæŸ¥è¯¢" style="width: 200px;">
            <button class="btn-search" onclick="searchInventory()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="loadInventory()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <input type="text" id="iName" placeholder="ç‰©å“åç§°">
            <input type="number" id="iQty" placeholder="åˆå§‹åº“å­˜" min="0" style="width:100px;">
            <input type="number" id="iThreshold" placeholder="è­¦æˆ’çº¿" min="0" style="width:100px;">
            <button class="btn-add" onclick="addInventory()">+ æ–°å¢ç‰©å“</button>
        </div>
        <table id="inventoryTable">
            <thead><tr><th>ID</th><th>ç‰©å“åç§°</th><th>å½“å‰åº“å­˜</th><th>è­¦æˆ’çº¿</th><th>å¤‡æ³¨çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 5. æœåŠ¡ -->
    <div id="service-section" class="module-section">
        <h3>ğŸ’‡ æœåŠ¡é¡¹ç›®ç®¡ç†</h3>
        <div class="search-box">
            <input type="text" id="searchServiceInput" placeholder="è¾“å…¥æœåŠ¡åç§°æˆ–ID" style="width: 200px;">
            <button class="btn-search" onclick="searchService()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="loadServices()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <button class="btn-add" onclick="openAddServiceModal()">+ æ–°å¢æœåŠ¡é¡¹ç›®</button>
        </div>
        <table id="serviceTable">
            <thead><tr><th>ID</th><th>æœåŠ¡åç§°</th><th>ä»·æ ¼</th><th>ç”¨æ—¶(åˆ†é’Ÿ)</th><th>æ¶ˆè€—ç‰©å“IDs</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 6. é¢„çº¦ç®¡ç† (æ–°å¢) -->
    <div id="appointment-section" class="module-section">
        <h3>ğŸ“… é¢„çº¦ç®¡ç†</h3>
        <div class="search-box">
            <input type="text" id="searchAppInput" placeholder="ID/ä¼šå‘˜/å‘˜å·¥ æˆ– 2026-01-01" style="width: 250px;">
            <button class="btn-search" onclick="searchApp()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn-cancel" onclick="loadApps()">ğŸ”„ é‡ç½®</button>
        </div>
        <div style="margin-bottom: 15px;">
            <button class="btn-add" onclick="openAddAppModal()">+ æ–°å¢é¢„çº¦</button>
        </div>
        <table id="appTable">
            <thead><tr><th>ID</th><th>æ—¥æœŸ</th><th>æ—¶é—´æ®µ</th><th>ä¼šå‘˜</th><th>æœåŠ¡é¡¹ç›®</th><th>å‘˜å·¥</th><th>å¤‡æ³¨</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- ================== å¼¹çª—ç»„ä»¶åŒº ================== -->

<!-- 1. ä¼šå‘˜ä¿®æ”¹ -->
<div id="editMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">âœï¸ ä¿®æ”¹ä¼šå‘˜ä¿¡æ¯</div>
        <input type="hidden" id="editMemId">
        <div class="form-group"><label>å§“å</label><input type="text" id="editMemName"></div>
        <div class="form-group"><label>æ‰‹æœºå·</label><input type="text" id="editMemPhone"></div>
        <div class="form-group"><label>æ€§åˆ«</label><select id="editMemGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('editMemberModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitEditMember()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 2. å‘˜å·¥ä¿®æ”¹ -->
<div id="editEmpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">âœï¸ ä¿®æ”¹å‘˜å·¥ä¿¡æ¯</div>
        <input type="hidden" id="editEmpId">
        <div class="form-group"><label>å§“å</label><input type="text" id="editEmpName"></div>
        <div class="form-group"><label>æ‰‹æœºå·</label><input type="text" id="editEmpPhone"></div>
        <div class="form-group"><label>æ€§åˆ«</label><select id="editEmpGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('editEmpModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitEditEmployee()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 3. ç®¡ç†å‘˜ä¿®æ”¹ -->
<div id="editAdminModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">âœï¸ ä¿®æ”¹ç®¡ç†å‘˜ä¿¡æ¯</div>
        <input type="hidden" id="editAdminId">
        <div class="form-group"><label>å§“å</label><input type="text" id="editAdminName"></div>
        <div class="form-group"><label>æ‰‹æœºå·</label><input type="text" id="editAdminPhone"></div>
        <div class="form-group"><label>æ€§åˆ«</label><select id="editAdminGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('editAdminModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitEditAdmin()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 4.1 åº“å­˜ä¿®æ”¹ -->
<div id="editInvModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">âœï¸ ä¿®æ”¹ç‰©å“ä¿¡æ¯</div>
        <input type="hidden" id="eiId">
        <div class="form-group"><label>ç‰©å“åç§°</label><input type="text" id="eiName"></div>
        <div class="form-group"><label>åº“å­˜æ•°é‡</label><input type="number" id="eiQty"></div>
        <div class="form-group"><label>è­¦æˆ’çº¿</label><input type="number" id="eiThreshold"></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('editInvModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitEditInv()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 4.2 é‡‡è´­ -->
<div id="purchaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">ğŸ›’ ç‰©å“é‡‡è´­å…¥åº“</div>
        <input type="hidden" id="purId">
        <p>æ­£åœ¨é‡‡è´­ï¼š<b id="purName"></b></p>
        <div class="form-group"><label>é‡‡è´­æ•°é‡ (å¿…é¡»å¤§äº0)</label><input type="number" id="purCount" placeholder="è¾“å…¥æ•°é‡"></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('purchaseModal')">å–æ¶ˆ</button><button class="btn-search" style="background-color: #6610f2;" onclick="submitPurchase()">ç¡®è®¤å…¥åº“</button></div>
    </div>
</div>

<!-- 5. æœåŠ¡ä¿®æ”¹/æ–°å¢ -->
<div id="serviceModal" class="modal">
    <div class="modal-content" style="width: 500px;">
        <div class="modal-header" id="serviceModalTitle">æ–°å¢æœåŠ¡</div>
        <input type="hidden" id="svcId">
        <div class="form-group"><label>æœåŠ¡åç§°</label><input type="text" id="svcName"></div>
        <div class="form-group"><label>ä»·æ ¼ (å…ƒ)</label><input type="number" id="svcPrice"></div>
        <div class="form-group">
            <label>æœåŠ¡ç”¨æ—¶ (åˆ†é’Ÿ)</label>
            <select id="svcDuration">
                <option value="60">60 åˆ†é’Ÿ (1å°æ—¶)</option>
                <option value="120">120 åˆ†é’Ÿ (2å°æ—¶)</option>
                <option value="180">180 åˆ†é’Ÿ (3å°æ—¶)</option>
            </select>
        </div>
        <hr style="margin: 15px 0; border:0; border-top:1px solid #eee;">
        <label style="font-weight:bold; display:block; margin-bottom:10px;">æ¶ˆè€—ç‰©å“ (æœ€å¤šé€‰5ä¸ª)</label>
        <div class="form-group"><select id="svcItem1" class="item-select"><option value="">-- æ— æ¶ˆè€— --</option></select></div>
        <div class="form-group"><select id="svcItem2" class="item-select"><option value="">-- æ— æ¶ˆè€— --</option></select></div>
        <div class="form-group"><select id="svcItem3" class="item-select"><option value="">-- æ— æ¶ˆè€— --</option></select></div>
        <div class="form-group"><select id="svcItem4" class="item-select"><option value="">-- æ— æ¶ˆè€— --</option></select></div>
        <div class="form-group"><select id="svcItem5" class="item-select"><option value="">-- æ— æ¶ˆè€— --</option></select></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('serviceModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitService()">ä¿å­˜</button></div>
    </div>
</div>

<!-- 6. æ–°å¢é¢„çº¦å¼¹çª— (æ–°å¢) -->
<div id="addAppModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">ğŸ“… æ–°å¢é¢„çº¦</div>
        <div class="form-group"><label>é€‰æ‹©æ—¥æœŸ</label><input type="date" id="appDate"></div>
        <div class="form-group">
            <label>å¼€å§‹æ—¶é—´ (æ•´ç‚¹)</label>
            <select id="appStartHour">
                <option value="" disabled selected>-- è¯·é€‰æ‹© --</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
            </select>
            <small style="color:#666">æ³¨: 12:00-14:00 ä¸ºåˆä¼‘</small>
        </div>
        <div class="form-group"><label>é€‰æ‹©ä¼šå‘˜</label><select id="appMemberId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="form-group"><label>é€‰æ‹©æœåŠ¡</label><select id="appServiceId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="form-group"><label>é€‰æ‹©å‘˜å·¥</label><select id="appEmployeeId"><option>åŠ è½½ä¸­...</option></select></div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('addAppModal')">å–æ¶ˆ</button><button class="btn-add" onclick="submitApp()">æäº¤é¢„çº¦</button></div>
    </div>
</div>

<script>
    let currentAdmin = null;
    const PHONE_REGEX = /^1[3-9]\d{9}$/;
    let inventoryCache = []; // æœåŠ¡å¼¹çª—ç”¨

    window.onload = function() {
        const str = localStorage.getItem('currentAdmin');
        if (!str) { window.location.href = '/login.html'; return; }
        try { currentAdmin = JSON.parse(str); document.getElementById('currentAdminName').innerText = currentAdmin.name; } catch(e) { window.location.href = '/login.html'; }
        updateTime(); setInterval(updateTime, 1000);
        loadMembers();
    };

    function updateTime() { document.getElementById('clock').innerText = new Date().toLocaleString(); }
    function logout() { if(confirm('ç¡®å®šé€€å‡ºå—ï¼Ÿ')) { localStorage.removeItem('currentAdmin'); window.location.href = '/login.html'; } }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function switchTab(t) {
        document.querySelectorAll('.module-section').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(d => d.classList.remove('active'));
        const targetSection = document.getElementById(t + '-section');
        if (targetSection) targetSection.classList.add('active');

        if(t === 'member') loadMembers();
        if(t === 'employee') loadEmployees();
        if(t === 'admin') loadAdmins();
        if(t === 'inventory') loadInventory();
        if(t === 'service') loadServices();
        if(t === 'appointment') loadApps(); // æ–°å¢
    }

    // --- ä¼šå‘˜ ---
    function loadMembers() { fetch('/api/members').then(r=>r.json()).then(renderMemberTable); }
    function renderMemberTable(data) {
        let h = ''; if(data.length===0) h='<tr><td colspan="6">æš‚æ— æ•°æ®</td></tr>';
        else data.forEach(m => h+=`<tr><td>${m.id}</td><td>${m.name}</td><td>${m.phone}</td><td>${m.gender}</td><td>Â¥${m.balance}</td><td><button class="btn-edit" onclick="openMemberModal('${m.id}','${m.name}','${m.phone}','${m.gender}')">ä¿®æ”¹</button><button class="btn-del" onclick="delMember(${m.id})">åˆ é™¤</button></td></tr>`);
        document.querySelector('#memberTable tbody').innerHTML = h;
    }
    function searchMember() { const k=document.getElementById('searchMemberInput').value.trim(); if(!k)return alert("ç©º"); fetch('/api/members/search?keyword='+k).then(r=>r.json()).then(renderMemberTable); }
    function resetMemberSearch() { document.getElementById('searchMemberInput').value=''; loadMembers(); }
    function openMemberModal(id,n,p,g){ document.getElementById('editMemId').value=id;document.getElementById('editMemName').value=n;document.getElementById('editMemPhone').value=p;document.getElementById('editMemGender').value=g;document.getElementById('editMemberModal').style.display='block';}
    function submitEditMember(){ const id=document.getElementById('editMemId').value,n=document.getElementById('editMemName').value,p=document.getElementById('editMemPhone').value,g=document.getElementById('editMemGender').value; if(!n||!p)return alert("ç©º"); if(!PHONE_REGEX.test(p))return alert("æ ¼å¼é”™"); fetch('/api/members/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name:n,phone:p,gender:g})}).then(()=>{alert("æˆåŠŸ");closeModal('editMemberModal');loadMembers();}); }
    function addMember(){ const n=document.getElementById('mName').value,p=document.getElementById('mPhone').value,g=document.getElementById('mGender').value; if(!n||!p)return alert("ç©º"); if(!PHONE_REGEX.test(p))return alert("æ ¼å¼é”™"); fetch('/api/members',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,phone:p,gender:g})}).then(()=>{alert("æˆåŠŸ");loadMembers();document.getElementById('mName').value='';document.getElementById('mPhone').value='';}); }
    function delMember(id){ if(confirm('åˆ ?')) fetch('/api/members/'+id,{method:'DELETE'}).then(()=>loadMembers()); }

    // --- å‘˜å·¥ ---
    function loadEmployees() { fetch('/api/employees').then(r=>r.json()).then(renderEmpTable); }
    function renderEmpTable(data) { let h=''; if(data.length===0)h='<tr><td colspan="5">æ— </td></tr>'; else data.forEach(e=>h+=`<tr><td>${e.id}</td><td>${e.name}</td><td>${e.phone}</td><td>${e.gender}</td><td><button class="btn-edit" onclick="openEmpModal(${e.id},'${e.name}','${e.phone}','${e.gender}')">ä¿®æ”¹</button><button class="btn-del" onclick="delEmployee(${e.id})">åˆ é™¤</button></td></tr>`); document.querySelector('#employeeTable tbody').innerHTML=h;}
    function searchEmployee(){ const k=document.getElementById('searchEmpInput').value.trim(); if(!k)return alert("ç©º"); fetch('/api/employees/search?keyword='+k).then(r=>r.json()).then(renderEmpTable); }
    function resetEmployeeSearch(){ document.getElementById('searchEmpInput').value=''; loadEmployees(); }
    function openEmpModal(id,n,p,g){ document.getElementById('editEmpId').value=id;document.getElementById('editEmpName').value=n;document.getElementById('editEmpPhone').value=p;document.getElementById('editEmpGender').value=g;document.getElementById('editEmpModal').style.display='block';}
    function submitEditEmployee(){ const id=document.getElementById('editEmpId').value,n=document.getElementById('editEmpName').value,p=document.getElementById('editEmpPhone').value,g=document.getElementById('editEmpGender').value; if(!n||!p)return alert("ç©º");if(!PHONE_REGEX.test(p))return alert("æ ¼å¼é”™"); fetch('/api/employees/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name:n,phone:p,gender:g})}).then(()=>{alert("æˆåŠŸ");closeModal('editEmpModal');loadEmployees();}); }
    function addEmployee(){ const n=document.getElementById('eName').value,p=document.getElementById('ePhone').value,g=document.getElementById('eGender').value; if(!n||!p)return alert("ç©º");if(!PHONE_REGEX.test(p))return alert("æ ¼å¼é”™"); fetch('/api/employees',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,phone:p,gender:g})}).then(()=>{alert("æˆåŠŸ");loadEmployees();document.getElementById('eName').value='';document.getElementById('ePhone').value='';}); }
    function delEmployee(id){ if(confirm('åˆ ?')) fetch('/api/employees/'+id,{method:'DELETE'}).then(()=>loadEmployees()); }

    // --- ç®¡ç†å‘˜ ---
    function loadAdmins(){ fetch('/api/admins').then(r=>r.json()).then(d=>{ let h=''; d.forEach(a=>h+=`<tr><td>${a.id}</td><td>${a.name}</td><td>${a.phone}</td><td>${a.gender}</td><td><button class="btn-edit" onclick="openAdminModal(${a.id},'${a.name}','${a.phone}','${a.gender}')">ä¿®æ”¹</button><button class="btn-del" onclick="delAdmin(${a.id})">åˆ é™¤</button></td></tr>`); document.querySelector('#adminTable tbody').innerHTML=h; }); }
    function openAdminModal(id,n,p,g){ document.getElementById('editAdminId').value=id;document.getElementById('editAdminName').value=n;document.getElementById('editAdminPhone').value=p;document.getElementById('editAdminGender').value=g;document.getElementById('editAdminModal').style.display='block';}
    function submitEditAdmin(){ const id=document.getElementById('editAdminId').value,n=document.getElementById('editAdminName').value,p=document.getElementById('editAdminPhone').value,g=document.getElementById('editAdminGender').value; if(!n||!p)return alert("ç©º");if(!PHONE_REGEX.test(p))return alert("æ ¼å¼é”™"); fetch('/api/admins',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name:n,phone:p,gender:g})}).then(r=>{if(r.ok){alert("æˆåŠŸ");closeModal('editAdminModal');loadAdmins();}else alert("å¤±è´¥")}); }
    function addAdmin(){ const n=document.getElementById('aName').value,p=document.getElementById('aPhone').value,g=document.getElementById('aGender').value; if(!n||!p)return alert("ç©º");if(!PHONE_REGEX.test(p))return alert("æ ¼å¼é”™"); fetch('/api/admins',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,phone:p,gender:g})}).then(r=>{if(r.ok){alert("æˆåŠŸ");loadAdmins();document.getElementById('aName').value='';document.getElementById('aPhone').value='';}else alert("å¤±è´¥")}); }
    function delAdmin(id){ if(confirm('åˆ ?')) fetch(`/api/admins/${id}?currentAdminId=${currentAdmin.id}`,{method:'DELETE'}).then(r=>{if(r.ok)loadAdmins();else alert("å¤±è´¥")}); }

    // --- åº“å­˜ ---
    function loadInventory(){ document.getElementById('searchInv').value=''; fetch('/api/inventory').then(r=>r.json()).then(renderInvTable); }
    function renderInvTable(data){ let h=''; if(data.length===0)h='<tr><td colspan="6">æ— </td></tr>'; else data.forEach(i=>{ let =i.remark&&i.remark.includes('ä¸è¶³')?'color:red':'color:green'; h+=`<tr><td>${i.id}</td><td>${i.name}</td><td>${i.quantity}</td><td>${i.threshold}</td><td style="${}">${i.remark||''}</td><td><button class="btn-search" style="background:#6610f2" onclick="openPurchase(${i.id},'${i.name}')">é‡‡è´­</button><button class="btn-edit" onclick="openInvModal(${i.id},'${i.name}',${i.quantity},${i.threshold})">ä¿®æ”¹</button><button class="btn-del" onclick="delInventory(${i.id})">åˆ é™¤</button></td></tr>`;}); document.querySelector('#inventoryTable tbody').innerHTML=h; }
    function searchInventory(){ const k=document.getElementById('searchInv').value.trim(); if(!k)return loadInventory(); fetch('/api/inventory/search?keyword='+k).then(r=>r.json()).then(renderInvTable); }
    function addInventory(){ const n=document.getElementById('iName').value,q=document.getElementById('iQty').value,t=document.getElementById('iThreshold').value; if(!n||!q||!t)return alert("ç©º"); fetch('/api/inventory',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,quantity:q,threshold:t})}).then(()=>{alert("æˆåŠŸ");loadInventory();document.getElementById('iName').value='';}); }
    function openInvModal(id,n,q,t){ document.getElementById('eiId').value=id;document.getElementById('eiName').value=n;document.getElementById('eiQty').value=q;document.getElementById('eiThreshold').value=t;document.getElementById('editInvModal').style.display='block';}
    function submitEditInv(){ const id=document.getElementById('eiId').value,n=document.getElementById('eiName').value,q=document.getElementById('eiQty').value,t=document.getElementById('eiThreshold').value; if(q<0||t<0)return alert("è´Ÿæ•°"); fetch('/api/inventory',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,name:n,quantity:q,threshold:t})}).then(()=>{alert("æˆåŠŸ");closeModal('editInvModal');loadInventory();}); }
    function openPurchase(id,n){ document.getElementById('purId').value=id;document.getElementById('purName').innerText=n;document.getElementById('purCount').value='';document.getElementById('purchaseModal').style.display='block';}
    function submitPurchase(){ const id=document.getElementById('purId').value,c=document.getElementById('purCount').value; if(c<=0)return alert("å¿…é¡»>0"); fetch(`/api/inventory/${id}/purchase`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({count:parseInt(c)})}).then(()=>{alert("æˆåŠŸ");closeModal('purchaseModal');loadInventory();}); }
    function delInventory(id){ if(confirm('åˆ ?')) fetch('/api/inventory/'+id,{method:'DELETE'}).then(()=>loadInventory()); }

    // --- æœåŠ¡ ---
    function loadServices(){ document.getElementById('searchServiceInput').value=''; fetch('/api/services').then(r=>r.json()).then(renderServiceTable); fetch('/api/inventory').then(r=>r.json()).then(d=>{inventoryCache=d;}); }
    function renderServiceTable(data){ let h=''; if(data.length===0)h='<tr><td colspan="6">æ— </td></tr>'; else data.forEach(=>{ h+=`<tr><td>${.id}</td><td>${.name}</td><td style="color:#d35400">Â¥${.price}</td><td>${.duration}åˆ†</td><td style="font-size:12px">${.consumeItemIds||'æ— '}</td><td><button class="btn-edit" onclick="openEditService(${.id},'${.name}',${.price},${.duration},'${.consumeItemIds}')">ä¿®æ”¹</button><button class="btn-del" onclick="delService(${.id})">åˆ é™¤</button></td></tr>`;}); document.querySelector('#serviceTable tbody').innerHTML=h; }
    function searchService(){ const k=document.getElementById('searchServiceInput').value.trim(); if(!k)return loadServices(); fetch('/api/services/search?keyword='+k).then(r=>r.json()).then(renderServiceTable); }
    function fillItemSelects(idsStr){ let arr=[]; if(idsStr) arr=idsStr.split(',').map(Number); for(let i=1;i<=5;i++){ const sel=document.getElementById('svcItem'+i); sel.innerHTML='<option value="">-- æ— æ¶ˆè€— --</option>'; inventoryCache.forEach(it=>{ const op=document.createElement('option'); op.value=it.id; op.innerText=it.name; if(arr[i-1]===it.id)op.selected=true; sel.appendChild(op); }); } }
    function openAddServiceModal(){ document.getElementById('serviceModalTitle').innerText="æ–°å¢æœåŠ¡"; document.getElementById('svcId').value=''; document.getElementById('svcName').value=''; document.getElementById('svcPrice').value=''; document.getElementById('svcDuration').value=''; fillItemSelects(""); document.getElementById('serviceModal').style.display='block'; }
    function openEditService(id,n,p,d,ids){ document.getElementById('serviceModalTitle').innerText="ä¿®æ”¹æœåŠ¡"; document.getElementById('svcId').value=id; document.getElementById('svcName').value=n; document.getElementById('svcPrice').value=p; document.getElementById('svcDuration').value=d; fillItemSelects(ids||""); document.getElementById('serviceModal').style.display='block'; }
    function submitService(){ const id=document.getElementById('svcId').value,n=document.getElementById('svcName').value,p=document.getElementById('svcPrice').value,d=document.getElementById('svcDuration').value; let ids=[]; for(let i=1;i<=5;i++){const v=document.getElementById('svcItem'+i).value;if(v)ids.push(v);} if(!n||!p||!d)return alert("ä¸å®Œæ•´"); const m=id?'PUT':'POST'; const u=id?('/api/services/'+id):'/api/services'; fetch(u,{method:m,headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,price:p,duration:d,consumeItemIds:ids.join(',')})}).then(async r=>{if(r.ok){alert("æˆåŠŸ");closeModal('serviceModal');loadServices();}else alert((await r.json()).message)}); }
    function delService(id){ if(confirm('åˆ ?')) fetch('/api/services/'+id,{method:'DELETE'}).then(()=>loadServices()); }

    // --- é¢„çº¦ (æ–°å¢æ¨¡å—é€»è¾‘) ---
    function loadApps() { document.getElementById('searchAppInput').value = ''; fetch('/api/appointments').then(r=>r.json()).then(renderAppTable); }
    function renderAppTable(data) {
        let h = ''; if(data.length===0) h='<tr><td colspan="9" style="text-align:center">æš‚æ— é¢„çº¦</td></tr>';
        else data.forEach(a => {
            let c = '#333'; if(a.status==='å¾…æœåŠ¡')c='#f39c12'; if(a.status==='å·²æœåŠ¡')c='#27ae60'; if(a.status==='å·²å–æ¶ˆ')c='#999';
            let btns = '';
            if(a.status==='å¾…æœåŠ¡') {
                btns = `<button style="background:#28a745;padding:4px 8px;font-size:12px" onclick="changeAppStatus(${a.id},'complete')">âœ… å·²æœåŠ¡</button>
                        <button style="background:#6c757d;padding:4px 8px;font-size:12px" onclick="changeAppStatus(${a.id},'cancel')">ğŸš« å–æ¶ˆ</button>`;
            } else btns='<span style="color:#ccc;font-size:12px">ä¸å¯æ“ä½œ</span>';
            h += `<tr><td>${a.id}</td><td>${a.appointmentDate}</td><td>${a.timeRange}</td><td>${a.memberName}</td><td>${a.serviceName}</td><td>${a.employeeName}</td><td style="color:#888;font-size:12px">${a.remark}</td><td style="color:${c};font-weight:bold">${a.status}</td><td>${btns} <button class="btn-del" style="padding:4px 8px;font-size:12px" onclick="delApp(${a.id})">åˆ é™¤</button></td></tr>`;
        });
        document.querySelector('#appTable tbody').innerHTML = h;
    }
    function searchApp() { const k=document.getElementById('searchAppInput').value.trim(); if(!k)return loadApps(); fetch('/api/appointments/search?keyword='+k).then(r=>r.json()).then(renderAppTable); }
    function openAddAppModal() {
        document.getElementById('appDate').valueAsDate = new Date();
        Promise.all([fetch('/api/members').then(r=>r.json()), fetch('/api/services').then(r=>r.json()), fetch('/api/employees').then(r=>r.json())])
        .then(([m,,e])=>{
            let h1='<option value="">--è¯·é€‰æ‹©--</option>'; m.forEach(x=>h1+=`<option value="${x.id}">${x.name}</option>`); document.getElementById('appMemberId').innerHTML=h1;
            let h2='<option value="">--è¯·é€‰æ‹©--</option>'; .forEach(x=>h2+=`<option value="${x.id}">${x.name} (${x.duration}åˆ†)</option>`); document.getElementById('appServiceId').innerHTML=h2;
            let h3='<option value="">--è¯·é€‰æ‹©--</option>'; e.forEach(x=>h3+=`<option value="${x.id}">${x.name}</option>`); document.getElementById('appEmployeeId').innerHTML=h3;
            document.getElementById('addAppModal').style.display='block';
        });
    }
    function submitApp() {
        const d=document.getElementById('appDate').value, sh=document.getElementById('appStartHour').value, m=document.getElementById('appMemberId').value, =document.getElementById('appServiceId').value, e=document.getElementById('appEmployeeId').value;
        if(!d||!sh||!m||!||!e) return alert("ä¸å®Œæ•´");
        fetch('/api/appointments', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:d,startHour:sh,memberId:m,serviceId:,employeeId:e})})
        .then(async r=>{if(r.ok){alert("æˆåŠŸ");closeModal('addAppModal');loadApps();}else alert((await r.json()).message)});
    }
    function changeAppStatus(id,act) { if(confirm(act==='complete'?'ç¡®è®¤å®Œæˆ? (æ‰£åº“å­˜)':'ç¡®è®¤å–æ¶ˆ?')) fetch(`/api/appointments/${id}/${act}`,{method:'POST'}).then(()=>loadApps()); }
    function delApp(id) { if(confirm('åˆ é™¤ä¸å¯æ¢å¤, ç¡®å®š?')) fetch('/api/appointments/'+id,{method:'DELETE'}).then(()=>loadApps()); }

</script>

</body>
</html>